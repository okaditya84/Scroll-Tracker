{"version":3,"file":"index.ts2.js","sources":["../../src/storage/queue.ts","../../src/utils/api.ts","../../src/background/index.ts"],"sourcesContent":["import type { TrackingPayload } from '@/types/tracking';\r\n\r\nconst QUEUE_KEY = 'scrollwise-event-queue';\r\n\r\nexport interface QueuedEvent {\r\n  id: string;\r\n  event: TrackingPayload;\r\n}\r\n\r\nconst createQueuedEvent = (event: TrackingPayload): QueuedEvent => ({\r\n  id: typeof crypto !== 'undefined' && 'randomUUID' in crypto ? crypto.randomUUID() : `${Date.now()}-${Math.random()}`,\r\n  event\r\n});\r\n\r\nconst normalizeQueue = (raw: unknown): QueuedEvent[] => {\r\n  if (!Array.isArray(raw)) {\r\n    return [];\r\n  }\r\n\r\n  return raw.map(item => {\r\n    if (item && typeof item === 'object' && 'id' in item && 'event' in item) {\r\n      const candidate = item as { id: string; event: TrackingPayload };\r\n      if (typeof candidate.id === 'string' && candidate.event) {\r\n        return candidate;\r\n      }\r\n    }\r\n    return createQueuedEvent(item as TrackingPayload);\r\n  });\r\n};\r\n\r\nconst writeQueue = async (queue: QueuedEvent[]) => {\r\n  if (queue.length) {\r\n    await chrome.storage.local.set({ [QUEUE_KEY]: queue });\r\n  } else {\r\n    await chrome.storage.local.remove(QUEUE_KEY);\r\n  }\r\n};\r\n\r\nconst readQueue = async (): Promise<QueuedEvent[]> => {\r\n  const stored = await chrome.storage.local.get(QUEUE_KEY);\r\n  const raw = stored[QUEUE_KEY];\r\n  const normalized = normalizeQueue(raw);\r\n  const needsUpgrade = Array.isArray(raw) && raw.some(item => !(item && typeof item === 'object' && 'id' in item && 'event' in item));\r\n  if (needsUpgrade && normalized.length) {\r\n    await writeQueue(normalized);\r\n  }\r\n  return normalized;\r\n};\r\n\r\nexport const enqueueEvents = async (events: TrackingPayload[]) => {\r\n  if (!events.length) return [] as string[];\r\n  const existing = await readQueue();\r\n  const next = events.map(createQueuedEvent);\r\n  await writeQueue([...existing, ...next]);\r\n  return next.map(item => item.id);\r\n};\r\n\r\nexport const getQueuedEvents = async () => readQueue();\r\n\r\nexport const removeQueuedEvents = async (ids: string[]) => {\r\n  if (!ids.length) return;\r\n  const existing = await readQueue();\r\n  const filtered = existing.filter(item => !ids.includes(item.id));\r\n  await writeQueue(filtered);\r\n};\r\n\r\nexport const clearQueue = async () => {\r\n  await chrome.storage.local.remove(QUEUE_KEY);\r\n};\r\n","import type { AuthState } from '../storage/auth';\r\nimport { getQueuedEvents, removeQueuedEvents } from '../storage/queue';\r\n\r\ntype ResolvedBase = { base: string; appended: boolean };\r\n\r\nconst stripTrailingSlash = (value: string) => value.replace(/\\/+$/, '');\r\nconst hasApiSegment = (value: string) => /\\/api(?:\\/|$)/i.test(value);\r\n\r\nconst resolveApiBase = (raw?: string): ResolvedBase | undefined => {\r\n  if (!raw) return undefined;\r\n  const trimmed = raw.trim();\r\n  if (!trimmed) return undefined;\r\n\r\n  const normalised = stripTrailingSlash(trimmed);\r\n\r\n  try {\r\n    const url = new URL(normalised);\r\n    const path = stripTrailingSlash(url.pathname || '');\r\n    if (!path || path === '') {\r\n      url.pathname = '/api';\r\n      return { base: stripTrailingSlash(url.toString()), appended: true };\r\n    }\r\n    if (hasApiSegment(path)) {\r\n      url.pathname = path;\r\n      return { base: stripTrailingSlash(url.toString()), appended: false };\r\n    }\r\n    url.pathname = `${path}/api`;\r\n    return { base: stripTrailingSlash(url.toString()), appended: true };\r\n  } catch {\r\n    if (hasApiSegment(normalised)) {\r\n      return { base: normalised, appended: false };\r\n    }\r\n    return { base: `${normalised}/api`, appended: true };\r\n  }\r\n};\r\n\r\nconst resolvedBase = resolveApiBase(import.meta.env.VITE_API_URL);\r\n\r\nif (!resolvedBase) {\r\n  throw new Error('VITE_API_URL is not configured');\r\n}\r\n\r\nif (resolvedBase.appended) {\r\n  // eslint-disable-next-line no-console\r\n  console.warn('[scrollwise] VITE_API_URL was missing an /api segment; using', resolvedBase.base);\r\n}\r\n\r\nconst API_URL = resolvedBase.base;\r\n\r\nexport interface UploadResult {\r\n  sentIds: string[];\r\n  hasMore: boolean;\r\n  requestAuthRefresh?: boolean;\r\n}\r\n\r\nconst BATCH_SIZE = 80;\r\n\r\nexport const sendEventsToApi = async (auth: AuthState): Promise<UploadResult | undefined> => {\r\n  const queued = await getQueuedEvents();\r\n  if (!queued.length || !auth.accessToken) {\r\n    return undefined;\r\n  }\r\n\r\n  const batch = queued.slice(0, BATCH_SIZE);\r\n  const response = await fetch(`${API_URL}/tracking/events`, {\r\n    method: 'POST',\r\n    headers: {\r\n      'Content-Type': 'application/json',\r\n      Authorization: `Bearer ${auth.accessToken}`\r\n    },\r\n    body: JSON.stringify({ events: batch.map(item => item.event) })\r\n  });\r\n\r\n  if (response.status === 401 && auth.refreshToken) {\r\n    const refreshed = await refreshAccessToken(auth);\r\n    return {\r\n      sentIds: [],\r\n      hasMore: true,\r\n      requestAuthRefresh: refreshed\r\n    };\r\n  }\r\n\r\n  if (!response.ok) {\r\n    throw new Error(`Failed to upload events: ${response.status}`);\r\n  }\r\n\r\n  await removeQueuedEvents(batch.map(item => item.id));\r\n  const remaining = await getQueuedEvents();\r\n\r\n  return {\r\n    sentIds: batch.map(item => item.id),\r\n    hasMore: remaining.length > 0\r\n  };\r\n};\r\n\r\nconst refreshAccessToken = async (auth: AuthState) => {\r\n  const response = await fetch(`${API_URL}/auth/refresh`, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify({ refreshToken: auth.refreshToken })\r\n  });\r\n\r\n  if (!response.ok) {\r\n    await chrome.storage.local.set({ 'scrollwise-auth': { trackingEnabled: false } });\r\n    return false;\r\n  }\r\n\r\n  const data = await response.json();\r\n  await chrome.storage.local.set({\r\n    'scrollwise-auth': {\r\n      ...auth,\r\n      accessToken: data.tokens.accessToken,\r\n      refreshToken: data.tokens.refreshToken,\r\n      trackingEnabled: true\r\n    }\r\n  });\r\n  return true;\r\n};\r\n","import { clearAuthState, getAuthState, setAuthState, syncTrackingFlag } from '@/storage/auth';\r\nimport { clearQueue, enqueueEvents, getQueuedEvents } from '@/storage/queue';\r\nimport { sendEventsToApi } from '@/utils/api';\r\n\r\nconst TRACKING_ALARM = 'scrollwise-upload';\r\nlet uploadInFlight: Promise<void> | null = null;\r\nlet uploadQueued = false;\r\n\r\nconst processUploadQueue = (reason: 'alarm' | 'enqueue') => {\r\n  const schedule = async () => {\r\n    const auth = await getAuthState();\r\n    if (!auth?.accessToken) {\r\n      return;\r\n    }\r\n\r\n    const result = await sendEventsToApi(auth);\r\n    if (result?.sentIds?.length) {\r\n      chrome.runtime\r\n        .sendMessage({ type: 'SUMMARY_INVALIDATE' })\r\n        .catch(() => undefined);\r\n    }\r\n\r\n    if (result?.hasMore || result?.requestAuthRefresh) {\r\n      uploadQueued = true;\r\n    }\r\n  };\r\n\r\n  if (uploadInFlight) {\r\n    uploadQueued = true;\r\n    return;\r\n  }\r\n\r\n  uploadInFlight = schedule()\r\n    .catch(error => {\r\n      console.warn(`[scrollwise] upload failed (${reason})`, error);\r\n    })\r\n    .finally(() => {\r\n      uploadInFlight = null;\r\n      if (uploadQueued) {\r\n        uploadQueued = false;\r\n        processUploadQueue('enqueue');\r\n      }\r\n    });\r\n};\r\n\r\nchrome.runtime.onInstalled.addListener(() => {\r\n  chrome.alarms.create(TRACKING_ALARM, { periodInMinutes: 1 });\r\n});\r\n\r\nchrome.runtime.onStartup.addListener(async () => {\r\n  await syncTrackingFlag();\r\n  const pending = await getQueuedEvents();\r\n  if (pending.length) {\r\n    processUploadQueue('alarm');\r\n  }\r\n});\r\n\r\nchrome.runtime.onMessage.addListener((message, _sender, sendResponse) => {\r\n  if (message.type === 'TRACKING_EVENT') {\r\n    void enqueueEvents(message.payload)\r\n      .then(async () => {\r\n        processUploadQueue('enqueue');\r\n        sendResponse({ ok: true });\r\n      })\r\n      .catch(error => sendResponse({ ok: false, error }));\r\n    return true;\r\n  }\r\n  if (message.type === 'AUTH_UPDATE') {\r\n    void setAuthState(message.payload)\r\n      .then(async () => {\r\n        await syncTrackingFlag();\r\n        processUploadQueue('enqueue');\r\n        sendResponse({ ok: true });\r\n      })\r\n      .catch(error => sendResponse({ ok: false, error }));\r\n    return true;\r\n  }\r\n  if (message.type === 'AUTH_LOGOUT') {\r\n    clearAuthState()\r\n      .then(async () => {\r\n        await clearQueue();\r\n        await syncTrackingFlag();\r\n        sendResponse({ ok: true });\r\n      })\r\n      .catch(error => sendResponse({ ok: false, error }));\r\n    return true;\r\n  }\r\n  if (message.type === 'TRACKING_TOGGLE') {\r\n    syncTrackingFlag().then(() => sendResponse({ ok: true }));\r\n    return true;\r\n  }\r\n  if (message.type === 'TRACKING_STATUS_REQUEST') {\r\n    void getAuthState()\r\n      .then(state => {\r\n        const enabled = Boolean(state?.trackingEnabled && state?.accessToken);\r\n        sendResponse({ enabled });\r\n      })\r\n      .catch(error => sendResponse({ enabled: false, error: (error as Error)?.message ?? 'unknown' }));\r\n    return true;\r\n  }\r\n  return false;\r\n});\r\n\r\nchrome.alarms.onAlarm.addListener(async alarm => {\r\n  if (alarm.name !== TRACKING_ALARM) return;\r\n  const pending = await getQueuedEvents();\r\n  if (!pending.length) return;\r\n  processUploadQueue('alarm');\r\n});\r\n"],"names":["QUEUE_KEY","createQueuedEvent","event","normalizeQueue","raw","item","candidate","writeQueue","queue","readQueue","normalized","enqueueEvents","events","existing","next","getQueuedEvents","removeQueuedEvents","ids","filtered","clearQueue","stripTrailingSlash","value","hasApiSegment","resolveApiBase","trimmed","normalised","url","path","resolvedBase","API_URL","BATCH_SIZE","sendEventsToApi","auth","queued","batch","response","refreshed","refreshAccessToken","remaining","data","TRACKING_ALARM","uploadInFlight","uploadQueued","processUploadQueue","reason","schedule","getAuthState","result","_a","error","syncTrackingFlag","message","_sender","sendResponse","setAuthState","clearAuthState","state","enabled","alarm"],"mappings":"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"}