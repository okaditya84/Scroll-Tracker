(function(){const Z="scrollwise-web";let l=!1,v,s=Date.now(),E;const c=[];let I=!1;const ee=8,D=6e4,f=new WeakMap;f.set(window,window.scrollY);const p={passive:!0,capture:!0},P={passive:!1,capture:!0},C={capture:!0},g=new Set,te=e=>{if(e instanceof Error)return e.message??"";if(typeof e=="object"&&e&&"message"in e){const t=e.message;return typeof t=="string"?t:""}return""},F=e=>{const t=te(e);return/extension context invalidated|receiving end does not exist|no tab with id/i.test(t)};let u,y=!1;const w=()=>{v&&(window.clearTimeout(v),v=void 0)},k=()=>{w(),!(!l||document.visibilityState!=="visible")&&(v=window.setTimeout(()=>{if(v=void 0,!l||document.visibilityState!=="visible")return;const e=Date.now(),t=Math.max(e-s,D);L({type:"idle",url:location.href,domain:b(location.href),durationMs:t,startedAt:new Date(e-t).toISOString(),metadata:{reason:"pointer-idle",thresholdMs:D}}),s=e,k()},D))},ne=()=>{u&&(window.clearTimeout(u),u=void 0)},x=()=>{g.forEach(e=>window.cancelAnimationFrame(e)),g.clear()},S=()=>{I||(I=!0,l=!1,c.length=0,w(),ne(),x(),E&&(window.clearInterval(E),E=void 0),ae(),console.debug("scrollwise: extension runtime invalidated, suspending messaging"))},h=()=>{var e;if(I||typeof chrome>"u"||!((e=chrome.runtime)!=null&&e.id))return!1;try{typeof chrome.runtime.getURL=="function"&&chrome.runtime.getURL("")}catch(t){return F(t)&&S(),!1}return!0},m=e=>h()?new Promise(t=>{const n=o=>{F(o)&&S(),t({ok:!1,error:o instanceof Error?o:void 0})};try{const o=chrome.runtime.sendMessage(e,r=>{const i=chrome.runtime.lastError;if(i){n(i);return}t({ok:!0,data:r})});typeof o<"u"&&typeof o.then=="function"&&o.then(r=>{t({ok:!0,data:r})}).catch(n)}catch(o){n(o)}}):(S(),Promise.resolve({ok:!1})),oe=()=>{if(window.location.protocol==="http:"||window.location.protocol==="https:")try{const e=window.localStorage.getItem("scrollwise-auth");if(!e)return;const t=JSON.parse(e);return t!=null&&t.accessToken?{accessToken:t.accessToken,refreshToken:t.refreshToken,user:t.user}:void 0}catch(e){console.warn("scrollwise: unable to parse local auth",e);return}},$=e=>{var n;if(!e)return null;const t=((n=e.user)==null?void 0:n.id)??"";return`${e.accessToken}:${e.refreshToken??""}:${t}`};let a=null;const N=(e=!1)=>{const t=oe(),n=$(t);if(!h())return;const r=e||t&&n!==a&&!a;t&&n!==a&&m({type:"AUTH_UPDATE",payload:{accessToken:t.accessToken,refreshToken:t.refreshToken,user:t.user,trackingEnabled:r?!0:void 0}}),!t&&a&&m({type:"AUTH_LOGOUT"}),a=n};N(!0);window.addEventListener("storage",()=>{N()});E=window.setInterval(()=>{N()},2e3);window.addEventListener("message",e=>{if(e.source!==window)return;const t=e.data;if(!(!t||typeof t!="object"||t.source!==Z)&&h()){if(t.type==="AUTH_UPDATE"){const n=t.payload??{};a=$({accessToken:n.accessToken,refreshToken:n.refreshToken,user:n.user})??a,m({type:"AUTH_UPDATE",payload:{accessToken:n.accessToken,refreshToken:n.refreshToken,user:n.user,trackingEnabled:n.trackingEnabled}})}t.type==="AUTH_LOGOUT"&&(m({type:"AUTH_LOGOUT"}),a=null)}});const B=e=>{l=e,e?(s=Date.now(),k()):(c.length=0,w())},T=()=>{if(!c.length)return;if(!h()){O();return}const e=[...c];c.length=0,m({type:"TRACKING_EVENT",payload:e}).then(t=>{t.ok||(c.unshift(...e),O())})},O=()=>{u&&window.clearTimeout(u),u=window.setTimeout(T,1500)},L=e=>{if(l){if(!h()){S();return}c.push(e),c.length>=8?T():O()}},b=e=>{try{return new URL(e).hostname.replace("www.","")}catch{return location.hostname}},U=e=>!e||e===document||e===document.body||e===document.documentElement?window:e instanceof HTMLElement||e instanceof Element?e:window,G=e=>{if(e===window)return window.scrollY;const t=e.scrollTop;return Number.isFinite(t)?t:0},_=e=>{f.has(e)||f.set(e,G(e))},se=e=>{var M,R;if(e===window)return"window";const t=e,n=((M=t.tagName)==null?void 0:M.toLowerCase())??"element",o=t.id?`#${t.id}`:"";let r="";const i=typeof t.className=="string"?t.className:typeof((R=t.className)==null?void 0:R.baseVal)=="string"?t.className.baseVal:"";return i&&(r=i.split(/\s+/).filter(Boolean).slice(0,2).map(X=>`.${X}`).join("")),`${n}${o}${r}`},H=(e,t="scroll")=>{_(e);const n=f.get(e)??0,o=G(e),r=Math.abs(o-n);if(r<ee)return;f.set(e,o);const i=Date.now();L({type:"scroll",url:location.href,domain:b(location.href),scrollDistance:r,durationMs:i-s,startedAt:new Date(s).toISOString(),metadata:{viewportHeight:window.innerHeight,container:se(e),source:t}}),s=i},A=(e,t,n=!1)=>{if(n){H(e,t);return}const o=window.requestAnimationFrame(()=>{g.delete(o),H(e,t)});g.add(o)},re=new Set(["ArrowDown","ArrowUp","PageDown","PageUp","Home","End","Space"]),K=e=>{d();const t=U(e.target);A(t,"scroll",!0)},V=e=>{d();const t=U(e.target);f.has(t)||_(t),A(t,"wheel")},Y=e=>{d();const t=U(e.target);A(t,"touch")},W=e=>{if(!re.has(e.key))return;d();const t=document.activeElement,n=t&&t!==document.body?t:window;_(n),A(n,"key")},j=e=>{var n;const t=Date.now();L({type:"click",url:location.href,domain:b(location.href),durationMs:t-s,startedAt:new Date(s).toISOString(),metadata:{tag:(n=e.target)==null?void 0:n.tagName,x:e.clientX,y:e.clientY}}),s=t,d()},d=()=>{l&&k()},q=()=>{s=Date.now(),d()},z=()=>{const e=document.visibilityState==="visible",t=Date.now();L({type:e?"focus":"blur",url:location.href,domain:b(location.href),startedAt:new Date(t).toISOString()}),s=t,e?k():(w(),T())},J=()=>{w(),s=Date.now(),T()},Q=()=>{w(),s=Date.now(),T()};function ie(){y||(document.addEventListener("scroll",K,p),document.addEventListener("wheel",V,P),document.addEventListener("touchmove",Y,p),document.addEventListener("keydown",W,C),document.addEventListener("click",j,{passive:!0}),document.addEventListener("mousemove",q,{passive:!0}),document.addEventListener("visibilitychange",z),window.addEventListener("beforeunload",J),window.addEventListener("pagehide",Q),y=!0)}function ae(){y&&(document.removeEventListener("scroll",K,p),document.removeEventListener("wheel",V,P),document.removeEventListener("touchmove",Y,p),document.removeEventListener("keydown",W,C),document.removeEventListener("click",j),document.removeEventListener("mousemove",q),document.removeEventListener("visibilitychange",z),window.removeEventListener("beforeunload",J),window.removeEventListener("pagehide",Q),x(),y=!1)}h()&&chrome.runtime.onMessage.addListener((e,t,n)=>{e.type==="SYNC_TRACKING"&&(B(!!e.enabled),n({enabled:l}))});d();m({type:"TRACKING_STATUS_REQUEST"}).then(e=>{var t;e.ok&&B(!!((t=e.data)!=null&&t.enabled))});ie();
//# sourceMappingURL=index.ts.js.map
})()
