import{g as re}from"./settings.js";const se="scrollwise-web",C="scrollwise-extension",B=()=>{try{window.localStorage.removeItem("scrollwise-auth")}catch(e){console.warn("scrollwise: unable to clear web auth storage",e)}window.postMessage({source:C,origin:"extension",type:"AUTH_LOGOUT"},"*")},ie=()=>new Promise(e=>{var t,n;if(!((n=(t=chrome==null?void 0:chrome.storage)==null?void 0:t.local)!=null&&n.get)){e(!1);return}try{chrome.storage.local.get("scrollwiseForceLogoutAt",o=>{e(!!(o!=null&&o.scrollwiseForceLogoutAt))})}catch(o){console.warn("scrollwise: unable to read forced logout flag",o),e(!1)}}),ae=()=>new Promise(e=>{var t,n;if(!((n=(t=chrome==null?void 0:chrome.storage)==null?void 0:t.local)!=null&&n.remove)){e();return}try{chrome.storage.local.remove("scrollwiseForceLogoutAt",()=>e())}catch(o){console.warn("scrollwise: unable to clear forced logout flag",o),e()}});let l=!1,T,r=Date.now(),E;const c=[];let U=!1;const ce=8,O=6e4,m=new WeakMap;m.set(window,window.scrollY);const y={passive:!0,capture:!0},G={passive:!1,capture:!0},$={capture:!0},S=new Set,le=e=>{if(e instanceof Error)return e.message??"";if(typeof e=="object"&&e&&"message"in e){const t=e.message;return typeof t=="string"?t:""}return""},x=e=>{const t=le(e);return/extension context invalidated|receiving end does not exist|no tab with id/i.test(t)};let w,k=!1;const u=()=>{T&&(window.clearTimeout(T),T=void 0)},L=()=>{u(),!(!l||document.visibilityState!=="visible")&&(T=window.setTimeout(()=>{if(T=void 0,!l||document.visibilityState!=="visible")return;const e=Date.now(),t=Math.max(e-r,O);A({type:"idle",url:location.href,domain:v(location.href),durationMs:t,startedAt:new Date(e-t).toISOString(),metadata:{reason:"pointer-idle",thresholdMs:O}}),r=e,L()},O))},K=()=>{w&&(window.clearTimeout(w),w=void 0)},V=()=>{S.forEach(e=>window.cancelAnimationFrame(e)),S.clear()},p=()=>{U||(U=!0,l=!1,c.length=0,u(),K(),V(),E&&(window.clearInterval(E),E=void 0),he(),console.debug("scrollwise: extension runtime invalidated, suspending messaging"))},h=()=>{var e;if(U||typeof chrome>"u"||!((e=chrome.runtime)!=null&&e.id))return!1;try{typeof chrome.runtime.getURL=="function"&&chrome.runtime.getURL("")}catch(t){return x(t)&&p(),!1}return!0},d=e=>h()?new Promise(t=>{const n=o=>{x(o)&&p(),t({ok:!1,error:o instanceof Error?o:void 0})};try{const o=chrome.runtime.sendMessage(e,i=>{const a=chrome.runtime.lastError;if(a){n(a);return}t({ok:!0,data:i})});typeof o<"u"&&typeof o.then=="function"&&o.then(i=>{t({ok:!0,data:i})}).catch(n)}catch(o){n(o)}}):(p(),Promise.resolve({ok:!1})),Y=()=>{if(window.location.protocol==="http:"||window.location.protocol==="https:")try{const e=window.localStorage.getItem("scrollwise-auth");if(!e)return;const t=JSON.parse(e);return t!=null&&t.accessToken?{accessToken:t.accessToken,refreshToken:t.refreshToken,user:t.user}:void 0}catch(e){console.warn("scrollwise: unable to parse local auth",e);return}},I=e=>{var n;if(!e)return null;const t=((n=e.user)==null?void 0:n.id)??"";return`${e.accessToken}:${e.refreshToken??""}:${t}`};let s=null;const de=e=>{e!=null&&e.accessToken&&window.postMessage({source:C,origin:"extension",type:"AUTH_UPDATE",payload:e},"*")},ue=e=>{if(e!=null&&e.accessToken)try{window.localStorage.setItem("scrollwise-auth",JSON.stringify(e))}catch(t){console.warn("scrollwise: unable to persist web auth storage",t)}},W=e=>{if(!e)return;const t=Y(),n=e.user?{...(t==null?void 0:t.user)??{},...e.user}:t==null?void 0:t.user,o={accessToken:e.accessToken??(t==null?void 0:t.accessToken)??"",refreshToken:e.refreshToken??(t==null?void 0:t.refreshToken),user:n};!o.accessToken||!o.refreshToken||!o.user||(ue(o),de(o),s=I(o))},N=async(e=!1)=>{const t=Y(),n=I(t);if(!h())return;if(await ie()&&t){B(),s=null,await ae();return}const a=e||t&&n!==s&&!s;t&&n!==s&&d({type:"AUTH_UPDATE",payload:{accessToken:t.accessToken,refreshToken:t.refreshToken,user:t.user,trackingEnabled:a?!0:void 0}}),!t&&s&&d({type:"AUTH_LOGOUT"}),s=n};N(!0);window.addEventListener("storage",()=>{N()});E=window.setInterval(()=>{N()},2e3);window.addEventListener("message",e=>{if(e.source!==window)return;const t=e.data;if(!(!t||typeof t!="object"||t.source!==se)&&h()){if(t.type==="AUTH_UPDATE"){const n=t.payload??{};s=I({accessToken:n.accessToken,refreshToken:n.refreshToken,user:n.user})??s,d({type:"AUTH_UPDATE",payload:{accessToken:n.accessToken,refreshToken:n.refreshToken,user:n.user,trackingEnabled:n.trackingEnabled}})}t.type==="AUTH_LOGOUT"&&(d({type:"AUTH_LOGOUT"}),s=null)}});const _=e=>{l=e,e?(r=Date.now(),L()):(c.length=0,u())},g=()=>{if(!c.length)return;if(!h()){D();return}const e=[...c];c.length=0,d({type:"TRACKING_EVENT",payload:e}).then(t=>{t.ok||(c.unshift(...e),D())})},D=()=>{w&&window.clearTimeout(w),w=window.setTimeout(g,1500)},A=async e=>{if(l){try{const t=await re(),n=e.domain||v(e.url||location.href);if(t.blocklist.includes(n))return}catch{}if(!h()){p();return}c.push(e),c.length>=8?g():D()}},v=e=>{try{return new URL(e).hostname.replace("www.","")}catch{return location.hostname}},H=e=>!e||e===document||e===document.body||e===document.documentElement?window:e instanceof HTMLElement||e instanceof Element?e:window,j=e=>{if(e===window)return window.scrollY;const t=e.scrollTop;return Number.isFinite(t)?t:0},M=e=>{m.has(e)||m.set(e,j(e))},fe=e=>{var P,R;if(e===window)return"window";const t=e,n=((P=t.tagName)==null?void 0:P.toLowerCase())??"element",o=t.id?`#${t.id}`:"";let i="";const a=typeof t.className=="string"?t.className:typeof((R=t.className)==null?void 0:R.baseVal)=="string"?t.className.baseVal:"";return a&&(i=a.split(/\s+/).filter(Boolean).slice(0,2).map(oe=>`.${oe}`).join("")),`${n}${o}${i}`},F=(e,t="scroll")=>{M(e);const n=m.get(e)??0,o=j(e),i=Math.abs(o-n);if(i<ce)return;m.set(e,o);const a=Date.now();A({type:"scroll",url:location.href,domain:v(location.href),scrollDistance:i,durationMs:a-r,startedAt:new Date(r).toISOString(),metadata:{viewportHeight:window.innerHeight,container:fe(e),source:t}}),r=a},b=(e,t,n=!1)=>{if(n){F(e,t);return}const o=window.requestAnimationFrame(()=>{S.delete(o),F(e,t)});S.add(o)},we=new Set(["ArrowDown","ArrowUp","PageDown","PageUp","Home","End","Space"]),J=e=>{f();const t=H(e.target);b(t,"scroll",!0)},Q=e=>{f();const t=H(e.target);m.has(t)||M(t),b(t,"wheel")},X=e=>{f();const t=H(e.target);b(t,"touch")},q=e=>{if(!we.has(e.key))return;f();const t=document.activeElement,n=t&&t!==document.body?t:window;M(n),b(n,"key")},z=e=>{var n;const t=Date.now();A({type:"click",url:location.href,domain:v(location.href),durationMs:t-r,startedAt:new Date(r).toISOString(),metadata:{tag:(n=e.target)==null?void 0:n.tagName,x:e.clientX,y:e.clientY}}),r=t,f()},f=()=>{l&&L()},Z=()=>{r=Date.now(),f()},ee=()=>{const e=document.visibilityState==="visible",t=Date.now();A({type:e?"focus":"blur",url:location.href,domain:v(location.href),startedAt:new Date(t).toISOString()}),r=t,e?L():(u(),g())},te=()=>{u(),r=Date.now(),g()},ne=()=>{u(),r=Date.now(),g()};function me(){k||(document.addEventListener("scroll",J,y),document.addEventListener("wheel",Q,G),document.addEventListener("touchmove",X,y),document.addEventListener("keydown",q,$),document.addEventListener("click",z,{passive:!0}),document.addEventListener("mousemove",Z,{passive:!0}),document.addEventListener("visibilitychange",ee),window.addEventListener("beforeunload",te),window.addEventListener("pagehide",ne),k=!0)}function he(){k&&(document.removeEventListener("scroll",J,y),document.removeEventListener("wheel",Q,G),document.removeEventListener("touchmove",X,y),document.removeEventListener("keydown",q,$),document.removeEventListener("click",z),document.removeEventListener("mousemove",Z),document.removeEventListener("visibilitychange",ee),window.removeEventListener("beforeunload",te),window.removeEventListener("pagehide",ne),V(),k=!1)}h()&&chrome.runtime.onMessage.addListener((e,t,n)=>{if(e.type==="SYNC_TRACKING"){_(!!e.enabled),n({enabled:l});return}if(e.type==="AUTH_STATE_PUSH"){W(e.payload),n({ok:!0});return}if(e.type==="AUTH_LOGOUT_BROADCAST"){_(!1),c.length=0,u(),K(),B(),s=null,n({ok:!0});return}});f();d({type:"TRACKING_STATUS_REQUEST"}).then(e=>{var t;e.ok&&_(!!((t=e.data)!=null&&t.enabled))});d({type:"AUTH_STATE_REQUEST"}).then(e=>{var t;e.ok&&((t=e.data)!=null&&t.state)&&W(e.data.state)});me();
//# sourceMappingURL=index.ts.js.map
