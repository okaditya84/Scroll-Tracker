import{g as te}from"./settings.js";const ne="scrollwise-web",oe="scrollwise-extension",P=()=>{try{window.localStorage.removeItem("scrollwise-auth")}catch(e){console.warn("scrollwise: unable to clear web auth storage",e)}window.postMessage({source:oe,type:"AUTH_LOGOUT"},"*")},re=()=>new Promise(e=>{var t,n;if(!((n=(t=chrome==null?void 0:chrome.storage)==null?void 0:t.local)!=null&&n.get)){e(!1);return}try{chrome.storage.local.get("scrollwiseForceLogoutAt",o=>{e(!!(o!=null&&o.scrollwiseForceLogoutAt))})}catch(o){console.warn("scrollwise: unable to read forced logout flag",o),e(!1)}}),se=()=>new Promise(e=>{var t,n;if(!((n=(t=chrome==null?void 0:chrome.storage)==null?void 0:t.local)!=null&&n.remove)){e();return}try{chrome.storage.local.remove("scrollwiseForceLogoutAt",()=>e())}catch(o){console.warn("scrollwise: unable to clear forced logout flag",o),e()}});let l=!1,g,r=Date.now(),E;const c=[];let D=!1;const ie=8,O=6e4,m=new WeakMap;m.set(window,window.scrollY);const p={passive:!0,capture:!0},C={passive:!1,capture:!0},B={capture:!0},y=new Set,ae=e=>{if(e instanceof Error)return e.message??"";if(typeof e=="object"&&e&&"message"in e){const t=e.message;return typeof t=="string"?t:""}return""},x=e=>{const t=ae(e);return/extension context invalidated|receiving end does not exist|no tab with id/i.test(t)};let f,S=!1;const d=()=>{g&&(window.clearTimeout(g),g=void 0)},k=()=>{d(),!(!l||document.visibilityState!=="visible")&&(g=window.setTimeout(()=>{if(g=void 0,!l||document.visibilityState!=="visible")return;const e=Date.now(),t=Math.max(e-r,O);b({type:"idle",url:location.href,domain:T(location.href),durationMs:t,startedAt:new Date(e-t).toISOString(),metadata:{reason:"pointer-idle",thresholdMs:O}}),r=e,k()},O))},G=()=>{f&&(window.clearTimeout(f),f=void 0)},$=()=>{y.forEach(e=>window.cancelAnimationFrame(e)),y.clear()},L=()=>{D||(D=!0,l=!1,c.length=0,d(),G(),$(),E&&(window.clearInterval(E),E=void 0),fe(),console.debug("scrollwise: extension runtime invalidated, suspending messaging"))},h=()=>{var e;if(D||typeof chrome>"u"||!((e=chrome.runtime)!=null&&e.id))return!1;try{typeof chrome.runtime.getURL=="function"&&chrome.runtime.getURL("")}catch(t){return x(t)&&L(),!1}return!0},w=e=>h()?new Promise(t=>{const n=o=>{x(o)&&L(),t({ok:!1,error:o instanceof Error?o:void 0})};try{const o=chrome.runtime.sendMessage(e,s=>{const i=chrome.runtime.lastError;if(i){n(i);return}t({ok:!0,data:s})});typeof o<"u"&&typeof o.then=="function"&&o.then(s=>{t({ok:!0,data:s})}).catch(n)}catch(o){n(o)}}):(L(),Promise.resolve({ok:!1})),ce=()=>{if(window.location.protocol==="http:"||window.location.protocol==="https:")try{const e=window.localStorage.getItem("scrollwise-auth");if(!e)return;const t=JSON.parse(e);return t!=null&&t.accessToken?{accessToken:t.accessToken,refreshToken:t.refreshToken,user:t.user}:void 0}catch(e){console.warn("scrollwise: unable to parse local auth",e);return}},K=e=>{var n;if(!e)return null;const t=((n=e.user)==null?void 0:n.id)??"";return`${e.accessToken}:${e.refreshToken??""}:${t}`};let a=null;const _=async(e=!1)=>{const t=ce(),n=K(t);if(!h())return;if(await re()&&t){P(),a=null,await se();return}const i=e||t&&n!==a&&!a;t&&n!==a&&w({type:"AUTH_UPDATE",payload:{accessToken:t.accessToken,refreshToken:t.refreshToken,user:t.user,trackingEnabled:i?!0:void 0}}),!t&&a&&w({type:"AUTH_LOGOUT"}),a=n};_(!0);window.addEventListener("storage",()=>{_()});E=window.setInterval(()=>{_()},2e3);window.addEventListener("message",e=>{if(e.source!==window)return;const t=e.data;if(!(!t||typeof t!="object"||t.source!==ne)&&h()){if(t.type==="AUTH_UPDATE"){const n=t.payload??{};a=K({accessToken:n.accessToken,refreshToken:n.refreshToken,user:n.user})??a,w({type:"AUTH_UPDATE",payload:{accessToken:n.accessToken,refreshToken:n.refreshToken,user:n.user,trackingEnabled:n.trackingEnabled}})}t.type==="AUTH_LOGOUT"&&(w({type:"AUTH_LOGOUT"}),a=null)}});const I=e=>{l=e,e?(r=Date.now(),k()):(c.length=0,d())},v=()=>{if(!c.length)return;if(!h()){U();return}const e=[...c];c.length=0,w({type:"TRACKING_EVENT",payload:e}).then(t=>{t.ok||(c.unshift(...e),U())})},U=()=>{f&&window.clearTimeout(f),f=window.setTimeout(v,1500)},b=async e=>{if(l){try{const t=await te(),n=e.domain||T(e.url||location.href);if(t.blocklist.includes(n))return}catch{}if(!h()){L();return}c.push(e),c.length>=8?v():U()}},T=e=>{try{return new URL(e).hostname.replace("www.","")}catch{return location.hostname}},N=e=>!e||e===document||e===document.body||e===document.documentElement?window:e instanceof HTMLElement||e instanceof Element?e:window,V=e=>{if(e===window)return window.scrollY;const t=e.scrollTop;return Number.isFinite(t)?t:0},R=e=>{m.has(e)||m.set(e,V(e))},le=e=>{var M,H;if(e===window)return"window";const t=e,n=((M=t.tagName)==null?void 0:M.toLowerCase())??"element",o=t.id?`#${t.id}`:"";let s="";const i=typeof t.className=="string"?t.className:typeof((H=t.className)==null?void 0:H.baseVal)=="string"?t.className.baseVal:"";return i&&(s=i.split(/\s+/).filter(Boolean).slice(0,2).map(ee=>`.${ee}`).join("")),`${n}${o}${s}`},F=(e,t="scroll")=>{R(e);const n=m.get(e)??0,o=V(e),s=Math.abs(o-n);if(s<ie)return;m.set(e,o);const i=Date.now();b({type:"scroll",url:location.href,domain:T(location.href),scrollDistance:s,durationMs:i-r,startedAt:new Date(r).toISOString(),metadata:{viewportHeight:window.innerHeight,container:le(e),source:t}}),r=i},A=(e,t,n=!1)=>{if(n){F(e,t);return}const o=window.requestAnimationFrame(()=>{y.delete(o),F(e,t)});y.add(o)},de=new Set(["ArrowDown","ArrowUp","PageDown","PageUp","Home","End","Space"]),Y=e=>{u();const t=N(e.target);A(t,"scroll",!0)},W=e=>{u();const t=N(e.target);m.has(t)||R(t),A(t,"wheel")},j=e=>{u();const t=N(e.target);A(t,"touch")},X=e=>{if(!de.has(e.key))return;u();const t=document.activeElement,n=t&&t!==document.body?t:window;R(n),A(n,"key")},q=e=>{var n;const t=Date.now();b({type:"click",url:location.href,domain:T(location.href),durationMs:t-r,startedAt:new Date(r).toISOString(),metadata:{tag:(n=e.target)==null?void 0:n.tagName,x:e.clientX,y:e.clientY}}),r=t,u()},u=()=>{l&&k()},z=()=>{r=Date.now(),u()},J=()=>{const e=document.visibilityState==="visible",t=Date.now();b({type:e?"focus":"blur",url:location.href,domain:T(location.href),startedAt:new Date(t).toISOString()}),r=t,e?k():(d(),v())},Q=()=>{d(),r=Date.now(),v()},Z=()=>{d(),r=Date.now(),v()};function ue(){S||(document.addEventListener("scroll",Y,p),document.addEventListener("wheel",W,C),document.addEventListener("touchmove",j,p),document.addEventListener("keydown",X,B),document.addEventListener("click",q,{passive:!0}),document.addEventListener("mousemove",z,{passive:!0}),document.addEventListener("visibilitychange",J),window.addEventListener("beforeunload",Q),window.addEventListener("pagehide",Z),S=!0)}function fe(){S&&(document.removeEventListener("scroll",Y,p),document.removeEventListener("wheel",W,C),document.removeEventListener("touchmove",j,p),document.removeEventListener("keydown",X,B),document.removeEventListener("click",q),document.removeEventListener("mousemove",z),document.removeEventListener("visibilitychange",J),window.removeEventListener("beforeunload",Q),window.removeEventListener("pagehide",Z),$(),S=!1)}h()&&chrome.runtime.onMessage.addListener((e,t,n)=>{if(e.type==="SYNC_TRACKING"){I(!!e.enabled),n({enabled:l});return}if(e.type==="AUTH_LOGOUT_BROADCAST"){I(!1),c.length=0,d(),G(),P(),a=null,n({ok:!0});return}});u();w({type:"TRACKING_STATUS_REQUEST"}).then(e=>{var t;e.ok&&I(!!((t=e.data)!=null&&t.enabled))});ue();
//# sourceMappingURL=index.ts.js.map
