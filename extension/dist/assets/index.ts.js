(function(){const J="scrollwise-web";let y=!1,l,c=Date.now(),v;const a=[];let b=!1;const Q=8,u=new WeakMap;u.set(window,window.scrollY);const T={passive:!0,capture:!0},R={passive:!1,capture:!0},M={capture:!0},E=new Set,X=e=>{if(e instanceof Error)return e.message??"";if(typeof e=="object"&&e&&"message"in e){const t=e.message;return typeof t=="string"?t:""}return""},H=e=>{const t=X(e);return/extension context invalidated|receiving end does not exist|no tab with id/i.test(t)};let d,p=!1;const Z=()=>{d&&(window.clearTimeout(d),d=void 0)},P=()=>{E.forEach(e=>window.cancelAnimationFrame(e)),E.clear()},g=()=>{b||(b=!0,y=!1,a.length=0,l&&(window.clearTimeout(l),l=void 0),Z(),P(),v&&(window.clearInterval(v),v=void 0),se(),console.debug("scrollwise: extension runtime invalidated, suspending messaging"))},m=()=>{var e;if(b||typeof chrome>"u"||!((e=chrome.runtime)!=null&&e.id))return!1;try{typeof chrome.runtime.getURL=="function"&&chrome.runtime.getURL("")}catch(t){return H(t)&&g(),!1}return!0},f=e=>m()?new Promise(t=>{const n=o=>{H(o)&&g(),t({ok:!1,error:o instanceof Error?o:void 0})};try{const o=chrome.runtime.sendMessage(e,s=>{const r=chrome.runtime.lastError;if(r){n(r);return}t({ok:!0,data:s})});typeof o<"u"&&typeof o.then=="function"&&o.then(s=>{t({ok:!0,data:s})}).catch(n)}catch(o){n(o)}}):(g(),Promise.resolve({ok:!1})),ee=()=>{if(window.location.protocol==="http:"||window.location.protocol==="https:")try{const e=window.localStorage.getItem("scrollwise-auth");if(!e)return;const t=JSON.parse(e);return t!=null&&t.accessToken?{accessToken:t.accessToken,refreshToken:t.refreshToken,user:t.user}:void 0}catch(e){console.warn("scrollwise: unable to parse local auth",e);return}},C=e=>{var n;if(!e)return null;const t=((n=e.user)==null?void 0:n.id)??"";return`${e.accessToken}:${e.refreshToken??""}:${t}`};let i=null;const O=(e=!1)=>{const t=ee(),n=C(t);if(!m())return;const s=e||t&&n!==i&&!i;t&&n!==i&&f({type:"AUTH_UPDATE",payload:{accessToken:t.accessToken,refreshToken:t.refreshToken,user:t.user,trackingEnabled:s?!0:void 0}}),!t&&i&&f({type:"AUTH_LOGOUT"}),i=n};O(!0);window.addEventListener("storage",()=>{O()});v=window.setInterval(()=>{O()},2e3);window.addEventListener("message",e=>{if(e.source!==window)return;const t=e.data;if(!(!t||typeof t!="object"||t.source!==J)&&m()){if(t.type==="AUTH_UPDATE"){const n=t.payload??{};i=C({accessToken:n.accessToken,refreshToken:n.refreshToken,user:n.user})??i,f({type:"AUTH_UPDATE",payload:{accessToken:n.accessToken,refreshToken:n.refreshToken,user:n.user,trackingEnabled:n.trackingEnabled}})}t.type==="AUTH_LOGOUT"&&(f({type:"AUTH_LOGOUT"}),i=null)}});const F=e=>{y=e,e?c=Date.now():a.length=0},h=()=>{if(!a.length)return;if(!m()){A();return}const e=[...a];a.length=0,f({type:"TRACKING_EVENT",payload:e}).then(t=>{t.ok||(a.unshift(...e),A())})},A=()=>{d&&window.clearTimeout(d),d=window.setTimeout(h,1500)},k=e=>{if(y){if(!m()){g();return}a.push(e),a.length>=8?h():A()}},S=e=>{try{return new URL(e).hostname.replace("www.","")}catch{return location.hostname}},I=e=>!e||e===document||e===document.body||e===document.documentElement?window:e instanceof HTMLElement||e instanceof Element?e:window,$=e=>{if(e===window)return window.scrollY;const t=e.scrollTop;return Number.isFinite(t)?t:0},N=e=>{u.has(e)||u.set(e,$(e))},te=e=>{var U,_;if(e===window)return"window";const t=e,n=((U=t.tagName)==null?void 0:U.toLowerCase())??"element",o=t.id?`#${t.id}`:"";let s="";const r=typeof t.className=="string"?t.className:typeof((_=t.className)==null?void 0:_.baseVal)=="string"?t.className.baseVal:"";return r&&(s=r.split(/\s+/).filter(Boolean).slice(0,2).map(z=>`.${z}`).join("")),`${n}${o}${s}`},D=(e,t="scroll")=>{N(e);const n=u.get(e)??0,o=$(e),s=Math.abs(o-n);if(s<Q)return;u.set(e,o);const r=Date.now();k({type:"scroll",url:location.href,domain:S(location.href),scrollDistance:s,durationMs:r-c,startedAt:new Date(c).toISOString(),metadata:{viewportHeight:window.innerHeight,container:te(e),source:t}}),c=r},L=(e,t,n=!1)=>{if(n){D(e,t);return}const o=window.requestAnimationFrame(()=>{E.delete(o),D(e,t)});E.add(o)},ne=new Set(["ArrowDown","ArrowUp","PageDown","PageUp","Home","End","Space"]),x=e=>{w();const t=I(e.target);L(t,"scroll",!0)},B=e=>{w();const t=I(e.target);u.has(t)||N(t),L(t,"wheel")},G=e=>{w();const t=I(e.target);L(t,"touch")},K=e=>{if(!ne.has(e.key))return;w();const t=document.activeElement,n=t&&t!==document.body?t:window;N(n),L(n,"key")},V=e=>{var n;const t=Date.now();k({type:"click",url:location.href,domain:S(location.href),durationMs:t-c,startedAt:new Date(c).toISOString(),metadata:{tag:(n=e.target)==null?void 0:n.tagName,x:e.clientX,y:e.clientY}}),c=t},w=()=>{l&&window.clearTimeout(l),l=window.setTimeout(()=>{k({type:"idle",url:location.href,domain:S(location.href),durationMs:6e4,startedAt:new Date().toISOString(),metadata:{reason:"pointer-idle"}})},6e4)},Y=()=>{w()},W=()=>{const e=document.visibilityState==="visible";k({type:e?"focus":"blur",url:location.href,domain:S(location.href),startedAt:new Date().toISOString()}),e||h()},j=()=>{h()},q=()=>{h()};function oe(){p||(document.addEventListener("scroll",x,T),document.addEventListener("wheel",B,R),document.addEventListener("touchmove",G,T),document.addEventListener("keydown",K,M),document.addEventListener("click",V,{passive:!0}),document.addEventListener("mousemove",Y,{passive:!0}),document.addEventListener("visibilitychange",W),window.addEventListener("beforeunload",j),window.addEventListener("pagehide",q),p=!0)}function se(){p&&(document.removeEventListener("scroll",x,T),document.removeEventListener("wheel",B,R),document.removeEventListener("touchmove",G,T),document.removeEventListener("keydown",K,M),document.removeEventListener("click",V),document.removeEventListener("mousemove",Y),document.removeEventListener("visibilitychange",W),window.removeEventListener("beforeunload",j),window.removeEventListener("pagehide",q),P(),p=!1)}m()&&chrome.runtime.onMessage.addListener((e,t,n)=>{e.type==="SYNC_TRACKING"&&(F(!!e.enabled),n({enabled:y}))});w();f({type:"TRACKING_STATUS_REQUEST"}).then(e=>{var t;e.ok&&F(!!((t=e.data)!=null&&t.enabled))});oe();
//# sourceMappingURL=index.ts.js.map
})()
