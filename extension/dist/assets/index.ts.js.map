{"version":3,"file":"index.ts.js","sources":["../../src/content/index.ts"],"sourcesContent":["import type { TrackingPayload } from '@/types/tracking';\r\n\r\nconst BROADCAST_SOURCE = 'scrollwise-web';\r\n\r\nlet trackingEnabled = false;\r\nlet idleTimer: number | undefined;\r\nlet lastActionAt = Date.now();\r\nlet storageSyncInterval: number | undefined;\r\nconst BUFFER: TrackingPayload[] = [];\r\nlet runtimeInvalidated = false;\r\ntype ScrollKey = Window | HTMLElement;\r\ntype ScrollSource = 'scroll' | 'wheel' | 'touch' | 'key';\r\nconst MIN_SCROLL_DELTA = 8;\r\nconst scrollOffsets = new WeakMap<ScrollKey, number>();\r\nscrollOffsets.set(window, window.scrollY);\r\n\r\nconst EVENT_LISTENER_OPTIONS: AddEventListenerOptions = { passive: true, capture: true };\r\nconst WHEEL_LISTENER_OPTIONS: AddEventListenerOptions = { passive: false, capture: true };\r\nconst KEYDOWN_LISTENER_OPTIONS: AddEventListenerOptions = { capture: true };\r\n\r\nconst pendingAnimationHandles = new Set<number>();\r\n\r\nconst resolveErrorMessage = (error: unknown) => {\r\n  if (error instanceof Error) return error.message ?? '';\r\n  if (typeof error === 'object' && error && 'message' in error) {\r\n    const message = (error as { message?: unknown }).message;\r\n    return typeof message === 'string' ? message : '';\r\n  }\r\n  return '';\r\n};\r\n\r\nconst isContextInvalidError = (error: unknown) => {\r\n  const message = resolveErrorMessage(error);\r\n  return /extension context invalidated|receiving end does not exist|no tab with id/i.test(message);\r\n};\r\n\r\nlet flushTimeout: number | undefined;\r\nlet listenersAttached = false;\r\n\r\nconst cancelScheduledFlush = () => {\r\n  if (flushTimeout) {\r\n    window.clearTimeout(flushTimeout);\r\n    flushTimeout = undefined;\r\n  }\r\n};\r\n\r\nconst cancelScheduledMeasurements = () => {\r\n  pendingAnimationHandles.forEach(handle => window.cancelAnimationFrame(handle));\r\n  pendingAnimationHandles.clear();\r\n};\r\n\r\nconst markRuntimeInvalidated = () => {\r\n  if (runtimeInvalidated) return;\r\n  runtimeInvalidated = true;\r\n  trackingEnabled = false;\r\n  BUFFER.length = 0;\r\n  if (idleTimer) {\r\n    window.clearTimeout(idleTimer);\r\n    idleTimer = undefined;\r\n  }\r\n  cancelScheduledFlush();\r\n  cancelScheduledMeasurements();\r\n  if (storageSyncInterval) {\r\n    window.clearInterval(storageSyncInterval);\r\n    storageSyncInterval = undefined;\r\n  }\r\n  detachTrackingListeners();\r\n  console.debug('scrollwise: extension runtime invalidated, suspending messaging');\r\n};\r\n\r\nconst isRuntimeAvailable = () => {\r\n  if (runtimeInvalidated) return false;\r\n  if (typeof chrome === 'undefined' || !chrome.runtime?.id) {\r\n    return false;\r\n  }\r\n\r\n  try {\r\n    if (typeof chrome.runtime.getURL === 'function') {\r\n      chrome.runtime.getURL('');\r\n    }\r\n  } catch (error) {\r\n    if (isContextInvalidError(error)) {\r\n      markRuntimeInvalidated();\r\n    }\r\n    return false;\r\n  }\r\n\r\n  return true;\r\n};\r\n\r\ntype MessageResult<T> = { ok: true; data: T | undefined } | { ok: false; error?: Error };\r\n\r\nconst safeSendMessage = <T = unknown>(message: unknown): Promise<MessageResult<T>> => {\r\n  if (!isRuntimeAvailable()) {\r\n    markRuntimeInvalidated();\r\n    return Promise.resolve({ ok: false });\r\n  }\r\n\r\n  return new Promise<MessageResult<T>>(resolve => {\r\n    const finalizeFailure = (error?: unknown) => {\r\n      if (isContextInvalidError(error)) {\r\n        markRuntimeInvalidated();\r\n      }\r\n      resolve({ ok: false, error: error instanceof Error ? error : undefined });\r\n    };\r\n\r\n    try {\r\n      const maybePromise = chrome.runtime.sendMessage(message, (response: T | undefined) => {\r\n        const runtimeError = chrome.runtime.lastError;\r\n        if (runtimeError) {\r\n          finalizeFailure(runtimeError);\r\n          return;\r\n        }\r\n        resolve({ ok: true, data: response });\r\n      });\r\n\r\n      if (typeof maybePromise !== 'undefined' && typeof (maybePromise as Promise<unknown>).then === 'function') {\r\n        (maybePromise as Promise<T | undefined>)\r\n          .then(response => {\r\n            resolve({ ok: true, data: response });\r\n          })\r\n          .catch(finalizeFailure);\r\n      }\r\n    } catch (error) {\r\n      finalizeFailure(error);\r\n    }\r\n  });\r\n};\r\n\r\ntype PageAuthSnapshot = {\r\n  accessToken: string;\r\n  refreshToken?: string;\r\n  user?: { id?: string; email?: string; displayName?: string; avatarUrl?: string };\r\n};\r\n\r\nconst readPageAuth = (): PageAuthSnapshot | undefined => {\r\n  if (!(window.location.protocol === 'http:' || window.location.protocol === 'https:')) {\r\n    return undefined;\r\n  }\r\n  try {\r\n    const raw = window.localStorage.getItem('scrollwise-auth');\r\n    if (!raw) return undefined;\r\n    const parsed = JSON.parse(raw);\r\n    if (!parsed?.accessToken) return undefined;\r\n    return {\r\n      accessToken: parsed.accessToken,\r\n      refreshToken: parsed.refreshToken,\r\n      user: parsed.user\r\n    };\r\n  } catch (error) {\r\n    console.warn('scrollwise: unable to parse local auth', error);\r\n    return undefined;\r\n  }\r\n};\r\n\r\nconst authHash = (auth?: PageAuthSnapshot | null) => {\r\n  if (!auth) return null;\r\n  const userId = auth.user?.id ?? '';\r\n  return `${auth.accessToken}:${auth.refreshToken ?? ''}:${userId}`;\r\n};\r\n\r\nlet lastAuthSignature: string | null = null;\r\n\r\nconst syncFromPageStorage = (activateTracking = false) => {\r\n  const snapshot = readPageAuth();\r\n  const nextSignature = authHash(snapshot);\r\n  const runtimeReady = isRuntimeAvailable();\r\n\r\n  if (!runtimeReady) {\r\n    return;\r\n  }\r\n\r\n  const shouldActivate = activateTracking || (snapshot && nextSignature !== lastAuthSignature && !lastAuthSignature);\r\n\r\n  if (snapshot && nextSignature !== lastAuthSignature) {\r\n    void safeSendMessage({\r\n      type: 'AUTH_UPDATE',\r\n      payload: {\r\n        accessToken: snapshot.accessToken,\r\n        refreshToken: snapshot.refreshToken,\r\n        user: snapshot.user,\r\n        trackingEnabled: shouldActivate ? true : undefined\r\n      }\r\n    });\r\n  }\r\n\r\n  if (!snapshot && lastAuthSignature) {\r\n    void safeSendMessage({ type: 'AUTH_LOGOUT' });\r\n  }\r\n\r\n  lastAuthSignature = nextSignature;\r\n};\r\n\r\nsyncFromPageStorage(true);\r\n\r\nwindow.addEventListener('storage', () => {\r\n  syncFromPageStorage();\r\n});\r\n\r\nstorageSyncInterval = window.setInterval(() => {\r\n  syncFromPageStorage();\r\n}, 2000);\r\n\r\nwindow.addEventListener('message', event => {\r\n  if (event.source !== window) {\r\n    return;\r\n  }\r\n\r\n  const data = event.data;\r\n  if (!data || typeof data !== 'object' || data.source !== BROADCAST_SOURCE) {\r\n    return;\r\n  }\r\n\r\n  if (!isRuntimeAvailable()) {\r\n    return;\r\n  }\r\n\r\n  if (data.type === 'AUTH_UPDATE') {\r\n    const payload = data.payload ?? {};\r\n    lastAuthSignature = authHash({\r\n      accessToken: payload.accessToken,\r\n      refreshToken: payload.refreshToken,\r\n      user: payload.user\r\n    }) ?? lastAuthSignature;\r\n    void safeSendMessage({\r\n      type: 'AUTH_UPDATE',\r\n      payload: {\r\n        accessToken: payload.accessToken,\r\n        refreshToken: payload.refreshToken,\r\n        user: payload.user,\r\n        trackingEnabled: payload.trackingEnabled\r\n      }\r\n    });\r\n  }\r\n\r\n  if (data.type === 'AUTH_LOGOUT') {\r\n    void safeSendMessage({ type: 'AUTH_LOGOUT' });\r\n    lastAuthSignature = null;\r\n  }\r\n});\r\n\r\nconst setTrackingEnabled = (enabled: boolean) => {\r\n  trackingEnabled = enabled;\r\n  if (!enabled) {\r\n    BUFFER.length = 0;\r\n  } else {\r\n    lastActionAt = Date.now();\r\n  }\r\n};\r\n\r\nconst flushBuffer = () => {\r\n  if (!BUFFER.length) return;\r\n  if (!isRuntimeAvailable()) {\r\n    scheduleFlush();\r\n    return;\r\n  }\r\n  const batch = [...BUFFER];\r\n  BUFFER.length = 0;\r\n  safeSendMessage({ type: 'TRACKING_EVENT', payload: batch }).then(result => {\r\n    if (!result.ok) {\r\n      // requeue if sending fails so we attempt again once connection resumes\r\n      BUFFER.unshift(...batch);\r\n      scheduleFlush();\r\n    }\r\n  });\r\n};\r\n\r\nconst scheduleFlush = () => {\r\n  if (flushTimeout) window.clearTimeout(flushTimeout);\r\n  flushTimeout = window.setTimeout(flushBuffer, 1500);\r\n};\r\n\r\nconst pushEvent = (event: TrackingPayload) => {\r\n  if (!trackingEnabled) return;\r\n  if (!isRuntimeAvailable()) {\r\n    markRuntimeInvalidated();\r\n    return;\r\n  }\r\n  BUFFER.push(event);\r\n  if (BUFFER.length >= 8) {\r\n    flushBuffer();\r\n  } else {\r\n    scheduleFlush();\r\n  }\r\n};\r\n\r\nconst urlDomain = (url: string) => {\r\n  try {\r\n    return new URL(url).hostname.replace('www.', '');\r\n  } catch {\r\n    return location.hostname;\r\n  }\r\n};\r\n\r\nconst resolveScrollTarget = (target: EventTarget | null): ScrollKey => {\r\n  if (!target) return window;\r\n  if (target === document || target === document.body || target === document.documentElement) {\r\n    return window;\r\n  }\r\n  if (target instanceof HTMLElement) {\r\n    return target;\r\n  }\r\n  if (target instanceof Element) {\r\n    return target as unknown as HTMLElement;\r\n  }\r\n  return window;\r\n};\r\n\r\nconst readScrollOffset = (target: ScrollKey) => {\r\n  if (target === window) {\r\n    return window.scrollY;\r\n  }\r\n\r\n  const value = (target as HTMLElement).scrollTop;\r\n  return Number.isFinite(value) ? value : 0;\r\n};\r\n\r\nconst seedScrollOffset = (target: ScrollKey) => {\r\n  if (!scrollOffsets.has(target)) {\r\n    scrollOffsets.set(target, readScrollOffset(target));\r\n  }\r\n};\r\n\r\nconst describeScrollTarget = (target: ScrollKey) => {\r\n  if (target === window) return 'window';\r\n  const element = target as HTMLElement;\r\n  const tag = element.tagName?.toLowerCase() ?? 'element';\r\n  const id = element.id ? `#${element.id}` : '';\r\n  let classList = '';\r\n  const rawClassName = typeof element.className === 'string'\r\n    ? element.className\r\n    : typeof (element.className as SVGAnimatedString | undefined)?.baseVal === 'string'\r\n      ? (element.className as SVGAnimatedString).baseVal\r\n      : '';\r\n  if (rawClassName) {\r\n    const tokens = rawClassName\r\n      .split(/\\s+/)\r\n      .filter(Boolean)\r\n      .slice(0, 2)\r\n      .map((cls: string) => `.${cls}`)\r\n      .join('');\r\n    classList = tokens;\r\n  }\r\n  return `${tag}${id}${classList}`;\r\n};\r\n\r\nconst recordScrollForTarget = (target: ScrollKey, source: ScrollSource = 'scroll') => {\r\n  seedScrollOffset(target);\r\n  const previous = scrollOffsets.get(target) ?? 0;\r\n  const current = readScrollOffset(target);\r\n  const delta = Math.abs(current - previous);\r\n  if (delta < MIN_SCROLL_DELTA) {\r\n    return;\r\n  }\r\n  scrollOffsets.set(target, current);\r\n  const now = Date.now();\r\n  pushEvent({\r\n    type: 'scroll',\r\n    url: location.href,\r\n    domain: urlDomain(location.href),\r\n    scrollDistance: delta,\r\n    durationMs: now - lastActionAt,\r\n    startedAt: new Date(lastActionAt).toISOString(),\r\n    metadata: {\r\n      viewportHeight: window.innerHeight,\r\n      container: describeScrollTarget(target),\r\n      source\r\n    }\r\n  });\r\n  lastActionAt = now;\r\n};\r\n\r\nconst scheduleScrollMeasurement = (target: ScrollKey, source: ScrollSource, immediate = false) => {\r\n  if (immediate) {\r\n    recordScrollForTarget(target, source);\r\n    return;\r\n  }\r\n\r\n  const handle = window.requestAnimationFrame(() => {\r\n    pendingAnimationHandles.delete(handle);\r\n    recordScrollForTarget(target, source);\r\n  });\r\n  pendingAnimationHandles.add(handle);\r\n};\r\n\r\nconst keyScrollKeys = new Set(['ArrowDown', 'ArrowUp', 'PageDown', 'PageUp', 'Home', 'End', 'Space']);\r\n\r\nconst handleScrollEvent = (event: Event) => {\r\n  resetIdleTimer();\r\n  const target = resolveScrollTarget(event.target);\r\n  scheduleScrollMeasurement(target, 'scroll', true);\r\n};\r\n\r\nconst handleWheel = (event: WheelEvent) => {\r\n  resetIdleTimer();\r\n  const target = resolveScrollTarget(event.target);\r\n  if (!scrollOffsets.has(target)) {\r\n    seedScrollOffset(target);\r\n  }\r\n  scheduleScrollMeasurement(target, 'wheel');\r\n};\r\n\r\nconst handleTouchMove = (event: TouchEvent) => {\r\n  resetIdleTimer();\r\n  const target = resolveScrollTarget(event.target);\r\n  scheduleScrollMeasurement(target, 'touch');\r\n};\r\n\r\nconst handleKeyDown = (event: KeyboardEvent) => {\r\n  if (!keyScrollKeys.has(event.key)) {\r\n    return;\r\n  }\r\n  resetIdleTimer();\r\n  const activeElement = document.activeElement as HTMLElement | null;\r\n  const target = activeElement && activeElement !== document.body ? activeElement : window;\r\n  seedScrollOffset(target);\r\n  scheduleScrollMeasurement(target, 'key');\r\n};\r\n\r\nconst handleClick = (event: MouseEvent) => {\r\n  const now = Date.now();\r\n  pushEvent({\r\n    type: 'click',\r\n    url: location.href,\r\n    domain: urlDomain(location.href),\r\n    durationMs: now - lastActionAt,\r\n    startedAt: new Date(lastActionAt).toISOString(),\r\n    metadata: {\r\n      tag: (event.target as HTMLElement)?.tagName,\r\n      x: event.clientX,\r\n      y: event.clientY\r\n    }\r\n  });\r\n  lastActionAt = now;\r\n};\r\n\r\nconst resetIdleTimer = () => {\r\n  if (idleTimer) window.clearTimeout(idleTimer);\r\n  idleTimer = window.setTimeout(() => {\r\n    pushEvent({\r\n      type: 'idle',\r\n      url: location.href,\r\n      domain: urlDomain(location.href),\r\n      durationMs: 60000,\r\n      startedAt: new Date().toISOString(),\r\n      metadata: { reason: 'pointer-idle' }\r\n    });\r\n  }, 60000);\r\n};\r\n\r\nconst handleMouseMove = () => {\r\n  resetIdleTimer();\r\n};\r\n\r\nconst handleVisibilityChange = () => {\r\n  const nowVisible = document.visibilityState === 'visible';\r\n  pushEvent({\r\n    type: nowVisible ? 'focus' : 'blur',\r\n    url: location.href,\r\n    domain: urlDomain(location.href),\r\n    startedAt: new Date().toISOString()\r\n  });\r\n  if (!nowVisible) {\r\n    flushBuffer();\r\n  }\r\n};\r\n\r\nconst handleBeforeUnload = () => {\r\n  flushBuffer();\r\n};\r\n\r\nconst handlePageHide = () => {\r\n  flushBuffer();\r\n};\r\n\r\nfunction attachTrackingListeners() {\r\n  if (listenersAttached) return;\r\n  document.addEventListener('scroll', handleScrollEvent, EVENT_LISTENER_OPTIONS);\r\n  document.addEventListener('wheel', handleWheel, WHEEL_LISTENER_OPTIONS);\r\n  document.addEventListener('touchmove', handleTouchMove, EVENT_LISTENER_OPTIONS);\r\n  document.addEventListener('keydown', handleKeyDown, KEYDOWN_LISTENER_OPTIONS);\r\n  document.addEventListener('click', handleClick, { passive: true });\r\n  document.addEventListener('mousemove', handleMouseMove, { passive: true });\r\n  document.addEventListener('visibilitychange', handleVisibilityChange);\r\n  window.addEventListener('beforeunload', handleBeforeUnload);\r\n  window.addEventListener('pagehide', handlePageHide);\r\n  listenersAttached = true;\r\n}\r\n\r\nfunction detachTrackingListeners() {\r\n  if (!listenersAttached) return;\r\n  document.removeEventListener('scroll', handleScrollEvent, EVENT_LISTENER_OPTIONS);\r\n  document.removeEventListener('wheel', handleWheel, WHEEL_LISTENER_OPTIONS);\r\n  document.removeEventListener('touchmove', handleTouchMove, EVENT_LISTENER_OPTIONS);\r\n  document.removeEventListener('keydown', handleKeyDown, KEYDOWN_LISTENER_OPTIONS);\r\n  document.removeEventListener('click', handleClick);\r\n  document.removeEventListener('mousemove', handleMouseMove);\r\n  document.removeEventListener('visibilitychange', handleVisibilityChange);\r\n  window.removeEventListener('beforeunload', handleBeforeUnload);\r\n  window.removeEventListener('pagehide', handlePageHide);\r\n  cancelScheduledMeasurements();\r\n  listenersAttached = false;\r\n}\r\n\r\nif (isRuntimeAvailable()) {\r\n  chrome.runtime.onMessage.addListener((message, _sender, sendResponse) => {\r\n    if (message.type === 'SYNC_TRACKING') {\r\n      setTrackingEnabled(Boolean(message.enabled));\r\n      sendResponse({ enabled: trackingEnabled });\r\n    }\r\n  });\r\n}\r\n\r\nresetIdleTimer();\r\n\r\nsafeSendMessage<{ enabled?: boolean }>({ type: 'TRACKING_STATUS_REQUEST' }).then(result => {\r\n  if (result.ok) {\r\n    setTrackingEnabled(Boolean(result.data?.enabled));\r\n  }\r\n});\r\n\r\nattachTrackingListeners();\r\n"],"names":["BROADCAST_SOURCE","trackingEnabled","idleTimer","lastActionAt","storageSyncInterval","BUFFER","runtimeInvalidated","MIN_SCROLL_DELTA","scrollOffsets","EVENT_LISTENER_OPTIONS","WHEEL_LISTENER_OPTIONS","KEYDOWN_LISTENER_OPTIONS","pendingAnimationHandles","resolveErrorMessage","error","message","isContextInvalidError","flushTimeout","listenersAttached","cancelScheduledFlush","cancelScheduledMeasurements","handle","markRuntimeInvalidated","detachTrackingListeners","isRuntimeAvailable","_a","safeSendMessage","resolve","finalizeFailure","maybePromise","response","runtimeError","readPageAuth","raw","parsed","authHash","auth","userId","lastAuthSignature","syncFromPageStorage","activateTracking","snapshot","nextSignature","shouldActivate","event","data","payload","setTrackingEnabled","enabled","flushBuffer","scheduleFlush","batch","result","pushEvent","urlDomain","url","resolveScrollTarget","target","readScrollOffset","value","seedScrollOffset","describeScrollTarget","_b","element","tag","id","classList","rawClassName","cls","recordScrollForTarget","source","previous","current","delta","now","scheduleScrollMeasurement","immediate","keyScrollKeys","handleScrollEvent","resetIdleTimer","handleWheel","handleTouchMove","handleKeyDown","activeElement","handleClick","handleMouseMove","handleVisibilityChange","nowVisible","handleBeforeUnload","handlePageHide","attachTrackingListeners","_sender","sendResponse"],"mappings":"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"}