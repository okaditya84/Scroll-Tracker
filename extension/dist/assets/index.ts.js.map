{"version":3,"file":"index.ts.js","sources":["../../src/content/index.ts"],"sourcesContent":["import type { TrackingPayload } from '@/types/tracking';\r\nimport { getSettings } from '@/storage/settings';\r\n\r\nconst BROADCAST_SOURCE = 'scrollwise-web';\r\n\r\nlet trackingEnabled = false;\r\nlet idleTimer: number | undefined;\r\nlet lastActionAt = Date.now();\r\nlet storageSyncInterval: number | undefined;\r\nconst BUFFER: TrackingPayload[] = [];\r\nlet runtimeInvalidated = false;\r\ntype ScrollKey = Window | HTMLElement;\r\ntype ScrollSource = 'scroll' | 'wheel' | 'touch' | 'key';\r\nconst MIN_SCROLL_DELTA = 8;\r\nconst IDLE_THRESHOLD_MS = 60_000;\r\nconst scrollOffsets = new WeakMap<ScrollKey, number>();\r\nscrollOffsets.set(window, window.scrollY);\r\n\r\nconst EVENT_LISTENER_OPTIONS: AddEventListenerOptions = { passive: true, capture: true };\r\nconst WHEEL_LISTENER_OPTIONS: AddEventListenerOptions = { passive: false, capture: true };\r\nconst KEYDOWN_LISTENER_OPTIONS: AddEventListenerOptions = { capture: true };\r\n\r\nconst pendingAnimationHandles = new Set<number>();\r\n\r\nconst resolveErrorMessage = (error: unknown) => {\r\n  if (error instanceof Error) return error.message ?? '';\r\n  if (typeof error === 'object' && error && 'message' in error) {\r\n    const message = (error as { message?: unknown }).message;\r\n    return typeof message === 'string' ? message : '';\r\n  }\r\n  return '';\r\n};\r\n\r\nconst isContextInvalidError = (error: unknown) => {\r\n  const message = resolveErrorMessage(error);\r\n  return /extension context invalidated|receiving end does not exist|no tab with id/i.test(message);\r\n};\r\n\r\nlet flushTimeout: number | undefined;\r\nlet listenersAttached = false;\r\n\r\nconst clearIdleTimer = () => {\r\n  if (!idleTimer) return;\r\n  window.clearTimeout(idleTimer);\r\n  idleTimer = undefined;\r\n};\r\n\r\nconst scheduleIdleTimer = () => {\r\n  clearIdleTimer();\r\n  if (!trackingEnabled || document.visibilityState !== 'visible') {\r\n    return;\r\n  }\r\n  idleTimer = window.setTimeout(() => {\r\n    idleTimer = undefined;\r\n    if (!trackingEnabled || document.visibilityState !== 'visible') {\r\n      return;\r\n    }\r\n    const now = Date.now();\r\n    const elapsed = Math.max(now - lastActionAt, IDLE_THRESHOLD_MS);\r\n      void pushEvent({\r\n      type: 'idle',\r\n      url: location.href,\r\n      domain: urlDomain(location.href),\r\n      durationMs: elapsed,\r\n      startedAt: new Date(now - elapsed).toISOString(),\r\n      metadata: { reason: 'pointer-idle', thresholdMs: IDLE_THRESHOLD_MS }\r\n    });\r\n    lastActionAt = now;\r\n    scheduleIdleTimer();\r\n  }, IDLE_THRESHOLD_MS);\r\n};\r\n\r\nconst cancelScheduledFlush = () => {\r\n  if (flushTimeout) {\r\n    window.clearTimeout(flushTimeout);\r\n    flushTimeout = undefined;\r\n  }\r\n};\r\n\r\nconst cancelScheduledMeasurements = () => {\r\n  pendingAnimationHandles.forEach(handle => window.cancelAnimationFrame(handle));\r\n  pendingAnimationHandles.clear();\r\n};\r\n\r\nconst markRuntimeInvalidated = () => {\r\n  if (runtimeInvalidated) return;\r\n  runtimeInvalidated = true;\r\n  trackingEnabled = false;\r\n  BUFFER.length = 0;\r\n  clearIdleTimer();\r\n  cancelScheduledFlush();\r\n  cancelScheduledMeasurements();\r\n  if (storageSyncInterval) {\r\n    window.clearInterval(storageSyncInterval);\r\n    storageSyncInterval = undefined;\r\n  }\r\n  detachTrackingListeners();\r\n  console.debug('scrollwise: extension runtime invalidated, suspending messaging');\r\n};\r\n\r\nconst isRuntimeAvailable = () => {\r\n  if (runtimeInvalidated) return false;\r\n  if (typeof chrome === 'undefined' || !chrome.runtime?.id) {\r\n    return false;\r\n  }\r\n\r\n  try {\r\n    if (typeof chrome.runtime.getURL === 'function') {\r\n      chrome.runtime.getURL('');\r\n    }\r\n  } catch (error) {\r\n    if (isContextInvalidError(error)) {\r\n      markRuntimeInvalidated();\r\n    }\r\n    return false;\r\n  }\r\n\r\n  return true;\r\n};\r\n\r\ntype MessageResult<T> = { ok: true; data: T | undefined } | { ok: false; error?: Error };\r\n\r\nconst safeSendMessage = <T = unknown>(message: unknown): Promise<MessageResult<T>> => {\r\n  if (!isRuntimeAvailable()) {\r\n    markRuntimeInvalidated();\r\n    return Promise.resolve({ ok: false });\r\n  }\r\n\r\n  return new Promise<MessageResult<T>>(resolve => {\r\n    const finalizeFailure = (error?: unknown) => {\r\n      if (isContextInvalidError(error)) {\r\n        markRuntimeInvalidated();\r\n      }\r\n      resolve({ ok: false, error: error instanceof Error ? error : undefined });\r\n    };\r\n\r\n    try {\r\n      const maybePromise = chrome.runtime.sendMessage(message, (response: T | undefined) => {\r\n        const runtimeError = chrome.runtime.lastError;\r\n        if (runtimeError) {\r\n          finalizeFailure(runtimeError);\r\n          return;\r\n        }\r\n        resolve({ ok: true, data: response });\r\n      });\r\n\r\n      if (typeof maybePromise !== 'undefined' && typeof (maybePromise as Promise<unknown>).then === 'function') {\r\n        (maybePromise as Promise<T | undefined>)\r\n          .then(response => {\r\n            resolve({ ok: true, data: response });\r\n          })\r\n          .catch(finalizeFailure);\r\n      }\r\n    } catch (error) {\r\n      finalizeFailure(error);\r\n    }\r\n  });\r\n};\r\n\r\ntype PageAuthSnapshot = {\r\n  accessToken: string;\r\n  refreshToken?: string;\r\n  user?: { id?: string; email?: string; displayName?: string; avatarUrl?: string };\r\n};\r\n\r\nconst readPageAuth = (): PageAuthSnapshot | undefined => {\r\n  if (!(window.location.protocol === 'http:' || window.location.protocol === 'https:')) {\r\n    return undefined;\r\n  }\r\n  try {\r\n    const raw = window.localStorage.getItem('scrollwise-auth');\r\n    if (!raw) return undefined;\r\n    const parsed = JSON.parse(raw);\r\n    if (!parsed?.accessToken) return undefined;\r\n    return {\r\n      accessToken: parsed.accessToken,\r\n      refreshToken: parsed.refreshToken,\r\n      user: parsed.user\r\n    };\r\n  } catch (error) {\r\n    console.warn('scrollwise: unable to parse local auth', error);\r\n    return undefined;\r\n  }\r\n};\r\n\r\nconst authHash = (auth?: PageAuthSnapshot | null) => {\r\n  if (!auth) return null;\r\n  const userId = auth.user?.id ?? '';\r\n  return `${auth.accessToken}:${auth.refreshToken ?? ''}:${userId}`;\r\n};\r\n\r\nlet lastAuthSignature: string | null = null;\r\n\r\nconst syncFromPageStorage = (activateTracking = false) => {\r\n  const snapshot = readPageAuth();\r\n  const nextSignature = authHash(snapshot);\r\n  const runtimeReady = isRuntimeAvailable();\r\n\r\n  if (!runtimeReady) {\r\n    return;\r\n  }\r\n\r\n  const shouldActivate = activateTracking || (snapshot && nextSignature !== lastAuthSignature && !lastAuthSignature);\r\n\r\n  if (snapshot && nextSignature !== lastAuthSignature) {\r\n    void safeSendMessage({\r\n      type: 'AUTH_UPDATE',\r\n      payload: {\r\n        accessToken: snapshot.accessToken,\r\n        refreshToken: snapshot.refreshToken,\r\n        user: snapshot.user,\r\n        trackingEnabled: shouldActivate ? true : undefined\r\n      }\r\n    });\r\n  }\r\n\r\n  if (!snapshot && lastAuthSignature) {\r\n    void safeSendMessage({ type: 'AUTH_LOGOUT' });\r\n  }\r\n\r\n  lastAuthSignature = nextSignature;\r\n};\r\n\r\nsyncFromPageStorage(true);\r\n\r\nwindow.addEventListener('storage', () => {\r\n  syncFromPageStorage();\r\n});\r\n\r\nstorageSyncInterval = window.setInterval(() => {\r\n  syncFromPageStorage();\r\n}, 2000);\r\n\r\nwindow.addEventListener('message', event => {\r\n  if (event.source !== window) {\r\n    return;\r\n  }\r\n\r\n  const data = event.data;\r\n  if (!data || typeof data !== 'object' || data.source !== BROADCAST_SOURCE) {\r\n    return;\r\n  }\r\n\r\n  if (!isRuntimeAvailable()) {\r\n    return;\r\n  }\r\n\r\n  if (data.type === 'AUTH_UPDATE') {\r\n    const payload = data.payload ?? {};\r\n    lastAuthSignature = authHash({\r\n      accessToken: payload.accessToken,\r\n      refreshToken: payload.refreshToken,\r\n      user: payload.user\r\n    }) ?? lastAuthSignature;\r\n    void safeSendMessage({\r\n      type: 'AUTH_UPDATE',\r\n      payload: {\r\n        accessToken: payload.accessToken,\r\n        refreshToken: payload.refreshToken,\r\n        user: payload.user,\r\n        trackingEnabled: payload.trackingEnabled\r\n      }\r\n    });\r\n  }\r\n\r\n  if (data.type === 'AUTH_LOGOUT') {\r\n    void safeSendMessage({ type: 'AUTH_LOGOUT' });\r\n    lastAuthSignature = null;\r\n  }\r\n});\r\n\r\nconst setTrackingEnabled = (enabled: boolean) => {\r\n  trackingEnabled = enabled;\r\n  if (!enabled) {\r\n    BUFFER.length = 0;\r\n    clearIdleTimer();\r\n  } else {\r\n    lastActionAt = Date.now();\r\n    scheduleIdleTimer();\r\n  }\r\n};\r\n\r\nconst flushBuffer = () => {\r\n  if (!BUFFER.length) return;\r\n  if (!isRuntimeAvailable()) {\r\n    scheduleFlush();\r\n    return;\r\n  }\r\n  const batch = [...BUFFER];\r\n  BUFFER.length = 0;\r\n  safeSendMessage({ type: 'TRACKING_EVENT', payload: batch }).then(result => {\r\n    if (!result.ok) {\r\n      // requeue if sending fails so we attempt again once connection resumes\r\n      BUFFER.unshift(...batch);\r\n      scheduleFlush();\r\n    }\r\n  });\r\n};\r\n\r\nconst scheduleFlush = () => {\r\n  if (flushTimeout) window.clearTimeout(flushTimeout);\r\n  flushTimeout = window.setTimeout(flushBuffer, 1500);\r\n};\r\n\r\nconst pushEvent = async (event: TrackingPayload) => {\r\n  if (!trackingEnabled) return;\r\n  try {\r\n    const settings = await getSettings();\r\n    const domain = event.domain || urlDomain(event.url || location.href);\r\n    if (settings.blocklist.includes(domain)) return;\r\n  } catch (e) {\r\n    // ignore settings read errors â€” do not block event capture\r\n  }\r\n\r\n  if (!isRuntimeAvailable()) {\r\n    markRuntimeInvalidated();\r\n    return;\r\n  }\r\n\r\n  BUFFER.push(event);\r\n  if (BUFFER.length >= 8) {\r\n    flushBuffer();\r\n  } else {\r\n    scheduleFlush();\r\n  }\r\n};\r\n\r\nconst urlDomain = (url: string) => {\r\n  try {\r\n    return new URL(url).hostname.replace('www.', '');\r\n  } catch {\r\n    return location.hostname;\r\n  }\r\n};\r\n\r\nconst resolveScrollTarget = (target: EventTarget | null): ScrollKey => {\r\n  if (!target) return window;\r\n  if (target === document || target === document.body || target === document.documentElement) {\r\n    return window;\r\n  }\r\n  if (target instanceof HTMLElement) {\r\n    return target;\r\n  }\r\n  if (target instanceof Element) {\r\n    return target as unknown as HTMLElement;\r\n  }\r\n  return window;\r\n};\r\n\r\nconst readScrollOffset = (target: ScrollKey) => {\r\n  if (target === window) {\r\n    return window.scrollY;\r\n  }\r\n\r\n  const value = (target as HTMLElement).scrollTop;\r\n  return Number.isFinite(value) ? value : 0;\r\n};\r\n\r\nconst seedScrollOffset = (target: ScrollKey) => {\r\n  if (!scrollOffsets.has(target)) {\r\n    scrollOffsets.set(target, readScrollOffset(target));\r\n  }\r\n};\r\n\r\nconst describeScrollTarget = (target: ScrollKey) => {\r\n  if (target === window) return 'window';\r\n  const element = target as HTMLElement;\r\n  const tag = element.tagName?.toLowerCase() ?? 'element';\r\n  const id = element.id ? `#${element.id}` : '';\r\n  let classList = '';\r\n  const rawClassName = typeof element.className === 'string'\r\n    ? element.className\r\n    : typeof (element.className as SVGAnimatedString | undefined)?.baseVal === 'string'\r\n      ? (element.className as SVGAnimatedString).baseVal\r\n      : '';\r\n  if (rawClassName) {\r\n    const tokens = rawClassName\r\n      .split(/\\s+/)\r\n      .filter(Boolean)\r\n      .slice(0, 2)\r\n      .map((cls: string) => `.${cls}`)\r\n      .join('');\r\n    classList = tokens;\r\n  }\r\n  return `${tag}${id}${classList}`;\r\n};\r\n\r\nconst recordScrollForTarget = (target: ScrollKey, source: ScrollSource = 'scroll') => {\r\n  seedScrollOffset(target);\r\n  const previous = scrollOffsets.get(target) ?? 0;\r\n  const current = readScrollOffset(target);\r\n  const delta = Math.abs(current - previous);\r\n  if (delta < MIN_SCROLL_DELTA) {\r\n    return;\r\n  }\r\n  scrollOffsets.set(target, current);\r\n  const now = Date.now();\r\n    void pushEvent({\r\n    type: 'scroll',\r\n    url: location.href,\r\n    domain: urlDomain(location.href),\r\n    scrollDistance: delta,\r\n    durationMs: now - lastActionAt,\r\n    startedAt: new Date(lastActionAt).toISOString(),\r\n    metadata: {\r\n      viewportHeight: window.innerHeight,\r\n      container: describeScrollTarget(target),\r\n      source\r\n    }\r\n  });\r\n  lastActionAt = now;\r\n};\r\n\r\nconst scheduleScrollMeasurement = (target: ScrollKey, source: ScrollSource, immediate = false) => {\r\n  if (immediate) {\r\n    recordScrollForTarget(target, source);\r\n    return;\r\n  }\r\n\r\n  const handle = window.requestAnimationFrame(() => {\r\n    pendingAnimationHandles.delete(handle);\r\n    recordScrollForTarget(target, source);\r\n  });\r\n  pendingAnimationHandles.add(handle);\r\n};\r\n\r\nconst keyScrollKeys = new Set(['ArrowDown', 'ArrowUp', 'PageDown', 'PageUp', 'Home', 'End', 'Space']);\r\n\r\nconst handleScrollEvent = (event: Event) => {\r\n  resetIdleTimer();\r\n  const target = resolveScrollTarget(event.target);\r\n  scheduleScrollMeasurement(target, 'scroll', true);\r\n};\r\n\r\nconst handleWheel = (event: WheelEvent) => {\r\n  resetIdleTimer();\r\n  const target = resolveScrollTarget(event.target);\r\n  if (!scrollOffsets.has(target)) {\r\n    seedScrollOffset(target);\r\n  }\r\n  scheduleScrollMeasurement(target, 'wheel');\r\n};\r\n\r\nconst handleTouchMove = (event: TouchEvent) => {\r\n  resetIdleTimer();\r\n  const target = resolveScrollTarget(event.target);\r\n  scheduleScrollMeasurement(target, 'touch');\r\n};\r\n\r\nconst handleKeyDown = (event: KeyboardEvent) => {\r\n  if (!keyScrollKeys.has(event.key)) {\r\n    return;\r\n  }\r\n  resetIdleTimer();\r\n  const activeElement = document.activeElement as HTMLElement | null;\r\n  const target = activeElement && activeElement !== document.body ? activeElement : window;\r\n  seedScrollOffset(target);\r\n  scheduleScrollMeasurement(target, 'key');\r\n};\r\n\r\nconst handleClick = (event: MouseEvent) => {\r\n  const now = Date.now();\r\n    void pushEvent({\r\n    type: 'click',\r\n    url: location.href,\r\n    domain: urlDomain(location.href),\r\n    durationMs: now - lastActionAt,\r\n    startedAt: new Date(lastActionAt).toISOString(),\r\n    metadata: {\r\n      tag: (event.target as HTMLElement)?.tagName,\r\n      x: event.clientX,\r\n      y: event.clientY\r\n    }\r\n  });\r\n  lastActionAt = now;\r\n  resetIdleTimer();\r\n};\r\n\r\nconst resetIdleTimer = () => {\r\n  if (!trackingEnabled) {\r\n    return;\r\n  }\r\n  scheduleIdleTimer();\r\n};\r\n\r\nconst handleMouseMove = () => {\r\n  lastActionAt = Date.now();\r\n  resetIdleTimer();\r\n};\r\n\r\nconst handleVisibilityChange = () => {\r\n  const nowVisible = document.visibilityState === 'visible';\r\n  const now = Date.now();\r\n    void pushEvent({\r\n    type: nowVisible ? 'focus' : 'blur',\r\n    url: location.href,\r\n    domain: urlDomain(location.href),\r\n    startedAt: new Date(now).toISOString()\r\n  });\r\n  lastActionAt = now;\r\n  if (!nowVisible) {\r\n    clearIdleTimer();\r\n    flushBuffer();\r\n  } else {\r\n    scheduleIdleTimer();\r\n  }\r\n};\r\n\r\nconst handleBeforeUnload = () => {\r\n  clearIdleTimer();\r\n  lastActionAt = Date.now();\r\n  flushBuffer();\r\n};\r\n\r\nconst handlePageHide = () => {\r\n  clearIdleTimer();\r\n  lastActionAt = Date.now();\r\n  flushBuffer();\r\n};\r\n\r\nfunction attachTrackingListeners() {\r\n  if (listenersAttached) return;\r\n  document.addEventListener('scroll', handleScrollEvent, EVENT_LISTENER_OPTIONS);\r\n  document.addEventListener('wheel', handleWheel, WHEEL_LISTENER_OPTIONS);\r\n  document.addEventListener('touchmove', handleTouchMove, EVENT_LISTENER_OPTIONS);\r\n  document.addEventListener('keydown', handleKeyDown, KEYDOWN_LISTENER_OPTIONS);\r\n  document.addEventListener('click', handleClick, { passive: true });\r\n  document.addEventListener('mousemove', handleMouseMove, { passive: true });\r\n  document.addEventListener('visibilitychange', handleVisibilityChange);\r\n  window.addEventListener('beforeunload', handleBeforeUnload);\r\n  window.addEventListener('pagehide', handlePageHide);\r\n  listenersAttached = true;\r\n}\r\n\r\nfunction detachTrackingListeners() {\r\n  if (!listenersAttached) return;\r\n  document.removeEventListener('scroll', handleScrollEvent, EVENT_LISTENER_OPTIONS);\r\n  document.removeEventListener('wheel', handleWheel, WHEEL_LISTENER_OPTIONS);\r\n  document.removeEventListener('touchmove', handleTouchMove, EVENT_LISTENER_OPTIONS);\r\n  document.removeEventListener('keydown', handleKeyDown, KEYDOWN_LISTENER_OPTIONS);\r\n  document.removeEventListener('click', handleClick);\r\n  document.removeEventListener('mousemove', handleMouseMove);\r\n  document.removeEventListener('visibilitychange', handleVisibilityChange);\r\n  window.removeEventListener('beforeunload', handleBeforeUnload);\r\n  window.removeEventListener('pagehide', handlePageHide);\r\n  cancelScheduledMeasurements();\r\n  listenersAttached = false;\r\n}\r\n\r\nif (isRuntimeAvailable()) {\r\n  chrome.runtime.onMessage.addListener((message, _sender, sendResponse) => {\r\n    if (message.type === 'SYNC_TRACKING') {\r\n      setTrackingEnabled(Boolean(message.enabled));\r\n      sendResponse({ enabled: trackingEnabled });\r\n    }\r\n  });\r\n}\r\n\r\nresetIdleTimer();\r\n\r\nsafeSendMessage<{ enabled?: boolean }>({ type: 'TRACKING_STATUS_REQUEST' }).then(result => {\r\n  if (result.ok) {\r\n    setTrackingEnabled(Boolean(result.data?.enabled));\r\n  }\r\n});\r\n\r\nattachTrackingListeners();\r\n"],"names":["BROADCAST_SOURCE","trackingEnabled","idleTimer","lastActionAt","storageSyncInterval","BUFFER","runtimeInvalidated","MIN_SCROLL_DELTA","IDLE_THRESHOLD_MS","scrollOffsets","EVENT_LISTENER_OPTIONS","WHEEL_LISTENER_OPTIONS","KEYDOWN_LISTENER_OPTIONS","pendingAnimationHandles","resolveErrorMessage","error","message","isContextInvalidError","flushTimeout","listenersAttached","clearIdleTimer","scheduleIdleTimer","now","elapsed","pushEvent","urlDomain","cancelScheduledFlush","cancelScheduledMeasurements","handle","markRuntimeInvalidated","detachTrackingListeners","isRuntimeAvailable","_a","safeSendMessage","resolve","finalizeFailure","maybePromise","response","runtimeError","readPageAuth","raw","parsed","authHash","auth","userId","lastAuthSignature","syncFromPageStorage","activateTracking","snapshot","nextSignature","shouldActivate","event","data","payload","setTrackingEnabled","enabled","flushBuffer","scheduleFlush","batch","result","settings","getSettings","domain","url","resolveScrollTarget","target","readScrollOffset","value","seedScrollOffset","describeScrollTarget","element","tag","id","classList","rawClassName","_b","cls","recordScrollForTarget","source","previous","current","delta","scheduleScrollMeasurement","immediate","keyScrollKeys","handleScrollEvent","resetIdleTimer","handleWheel","handleTouchMove","handleKeyDown","activeElement","handleClick","handleMouseMove","handleVisibilityChange","nowVisible","handleBeforeUnload","handlePageHide","attachTrackingListeners","_sender","sendResponse"],"mappings":"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"}