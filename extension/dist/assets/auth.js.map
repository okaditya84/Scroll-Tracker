{"version":3,"file":"auth.js","sources":["../../src/storage/auth.ts"],"sourcesContent":["export interface AuthState {\r\n  accessToken?: string;\r\n  refreshToken?: string;\r\n  user?: { id: string; displayName: string; email: string };\r\n  trackingEnabled: boolean;\r\n}\r\n\r\nconst STORAGE_KEY = 'scrollwise-auth';\r\n\r\nexport const getAuthState = async (): Promise<AuthState | undefined> => {\r\n  const store = await chrome.storage.local.get(STORAGE_KEY);\r\n  return store[STORAGE_KEY] as AuthState | undefined;\r\n};\r\n\r\ntype AuthStateUpdate = Partial<AuthState>;\r\n\r\nexport const setAuthState = async (update: AuthStateUpdate) => {\r\n  const current: AuthState = {\r\n    trackingEnabled: false,\r\n    ...(await getAuthState())\r\n  };\r\n\r\n  const next: AuthState = {\r\n    accessToken: update.accessToken ?? current.accessToken,\r\n    refreshToken: update.refreshToken ?? current.refreshToken,\r\n    user: update.user ?? current.user,\r\n    trackingEnabled: update.trackingEnabled ?? current.trackingEnabled\r\n  };\r\n\r\n  await chrome.storage.local.set({ [STORAGE_KEY]: next });\r\n  return next;\r\n};\r\n\r\nexport const clearAuthState = async () => {\r\n  await chrome.storage.local.remove(STORAGE_KEY);\r\n};\r\n\r\nexport const updateTrackingEnabled = async (enabled: boolean) => {\r\n  await setAuthState({ trackingEnabled: enabled });\r\n  await syncTrackingFlag();\r\n};\r\n\r\nexport const syncTrackingFlag = async () => {\r\n  const state = await getAuthState();\r\n  const enabled = Boolean(state?.trackingEnabled && state?.accessToken);\r\n  const tabs = await chrome.tabs.query({ url: '<all_urls>' });\r\n  await Promise.all(\r\n    tabs.map(tab =>\r\n      tab.id\r\n        ? chrome.tabs\r\n            .sendMessage(tab.id, { type: 'SYNC_TRACKING', enabled })\r\n            .catch(() => undefined)\r\n        : Promise.resolve()\r\n    )\r\n  );\r\n};\r\n"],"names":["STORAGE_KEY","getAuthState","setAuthState","update","current","next","clearAuthState","updateTrackingEnabled","enabled","syncTrackingFlag","state","tabs","tab"],"mappings":"AAOA,MAAMA,EAAc,kBAEPC,EAAe,UACZ,MAAM,OAAO,QAAQ,MAAM,IAAID,CAAW,GAC3CA,CAAW,EAKbE,EAAe,MAAOC,GAA4B,CAC7D,MAAMC,EAAqB,CACzB,gBAAiB,GACjB,GAAI,MAAMH,EAAA,CAAa,EAGnBI,EAAkB,CACtB,YAAaF,EAAO,aAAeC,EAAQ,YAC3C,aAAcD,EAAO,cAAgBC,EAAQ,aAC7C,KAAMD,EAAO,MAAQC,EAAQ,KAC7B,gBAAiBD,EAAO,iBAAmBC,EAAQ,eAAA,EAGrD,aAAM,OAAO,QAAQ,MAAM,IAAI,CAAE,CAACJ,CAAW,EAAGK,EAAM,EAC/CA,CACT,EAEaC,EAAiB,SAAY,CACxC,MAAM,OAAO,QAAQ,MAAM,OAAON,CAAW,CAC/C,EAEaO,EAAwB,MAAOC,GAAqB,CAC/D,MAAMN,EAAa,CAAE,gBAAiBM,EAAS,EAC/C,MAAMC,EAAA,CACR,EAEaA,EAAmB,SAAY,CAC1C,MAAMC,EAAQ,MAAMT,EAAA,EACdO,EAAU,GAAQE,GAAA,MAAAA,EAAO,kBAAmBA,GAAA,MAAAA,EAAO,cACnDC,EAAO,MAAM,OAAO,KAAK,MAAM,CAAE,IAAK,aAAc,EAC1D,MAAM,QAAQ,IACZA,EAAK,OACHC,EAAI,GACA,OAAO,KACJ,YAAYA,EAAI,GAAI,CAAE,KAAM,gBAAiB,QAAAJ,EAAS,EACtD,MAAM,MAAe,EACxB,QAAQ,QAAA,CAAQ,CACtB,CAEJ"}