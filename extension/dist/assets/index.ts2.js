import{s as T,a as B,c as Q,g as k}from"./auth.js";const h="scrollwise-event-queue",M=e=>({id:typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`${Date.now()}-${Math.random()}`,event:e}),K=e=>Array.isArray(e)?e.map(n=>{if(n&&typeof n=="object"&&"id"in n&&"event"in n){const a=n;if(typeof a.id=="string"&&a.event)return a}return M(n)}):[],S=async e=>{e.length?await chrome.storage.local.set({[h]:e}):await chrome.storage.local.remove(h)},E=async()=>{const n=(await chrome.storage.local.get(h))[h],a=K(n);return Array.isArray(n)&&n.some(r=>!(r&&typeof r=="object"&&"id"in r&&"event"in r))&&a.length&&await S(a),a},q=async e=>{if(!e.length)return[];const n=await E(),a=e.map(M);return await S([...n,...a]),a.map(t=>t.id)},A=async()=>E(),D=async e=>{if(!e.length)return;const a=(await E()).filter(t=>!e.includes(t.id));await S(a)},H=async()=>{await chrome.storage.local.remove(h)},d=e=>e.replace(/\/+$/,""),_=e=>/\/api(?:\/|$)/i.test(e),G=e=>{const n=e.trim();if(!n)return;const a=d(n);try{const t=new URL(a),r=d(t.pathname||"");return!r||r===""?(t.pathname="/api",{base:d(t.toString()),appended:!0}):_(r)?(t.pathname=r,{base:d(t.toString()),appended:!1}):(t.pathname=`${r}/api`,{base:d(t.toString()),appended:!0})}catch{return _(a)?{base:a,appended:!1}:{base:`${a}/api`,appended:!0}}},U=G("https://scroll-tracker.onrender.com/api");if(!U)throw new Error("VITE_API_URL is not configured");U.appended&&console.warn("[scrollwise] VITE_API_URL was missing an /api segment; using",U.base);const O=U.base,N=80;let f=null;const L=e=>new Promise(n=>setTimeout(n,e)),j=async(e,n)=>f||(f=(async()=>{var a;try{const t=await fetch(`${O}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e.refreshToken})});if(!t.ok)return await chrome.storage.local.set({"scrollwise-auth":{trackingEnabled:!1}}),null;const r=await t.json(),i={...(await chrome.storage.local.get("scrollwise-auth"))["scrollwise-auth"]??{},accessToken:r.tokens.accessToken,refreshToken:r.tokens.refreshToken,trackingEnabled:!0};return await chrome.storage.local.set({"scrollwise-auth":i}),await((a=n==null?void 0:n.onTokensUpdated)==null?void 0:a.call(n,i)),i}catch(t){return console.warn("[scrollwise] refresh failed",t.message??t),null}finally{f=null}})(),f),R=async(e,n)=>{const a=await A();if(!a.length||!e.accessToken)return;const t=a.slice(0,N),r={events:t.map(s=>({...s.event,idempotencyKey:s.id}))},w=3;let o=0,i=null;for(;o<w;){o+=1;try{const s=await fetch(`${O}/tracking/events`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.accessToken}`},body:JSON.stringify(r)});if(s.status===401&&e.refreshToken){if(!await j(e,n))return{sentIds:[],hasMore:!0,requestAuthRefresh:!1};const u=(await chrome.storage.local.get("scrollwise-auth"))["scrollwise-auth"];if(u!=null&&u.accessToken){e={...e,accessToken:u.accessToken,refreshToken:u.refreshToken??e.refreshToken};continue}}if(!s.ok){if(i=new Error(`Failed to upload events: ${s.status}`),s.status>=500){const m=200*Math.pow(2,o-1);await L(m);continue}throw i}const l=await s.json().catch(()=>({})),b=Array.isArray(l==null?void 0:l.acceptedKeys)?l.acceptedKeys:t.map(m=>m.id);b.length&&await D(b);const $=await A();return{sentIds:b,hasMore:$.length>0}}catch(s){i=s;const l=200*Math.pow(2,o-1);console.warn("[scrollwise] upload attempt failed",o,s.message??s),await L(l);continue}}if(i)throw i},I="scrollwise-upload";let v=null,y=!1;const g=async e=>{const n=await chrome.tabs.query({});await Promise.all(n.map(a=>a.id?chrome.tabs.sendMessage(a.id,e).catch(()=>{}):void 0))},F=async e=>{!(e!=null&&e.accessToken)||!(e!=null&&e.refreshToken)||await g({type:"AUTH_STATE_PUSH",payload:{accessToken:e.accessToken,refreshToken:e.refreshToken,user:e.user}})},x=()=>new Promise(e=>{chrome.storage.local.set({scrollwiseForceLogoutAt:Date.now()},()=>e())}),V=()=>new Promise(e=>{chrome.storage.local.remove("scrollwiseForceLogoutAt",()=>e())}),p=e=>{const n=async()=>{var r;const a=await k();if(!(a!=null&&a.accessToken))return;const t=await R(a,{onTokensUpdated:F});(r=t==null?void 0:t.sentIds)!=null&&r.length&&chrome.runtime.sendMessage({type:"SUMMARY_INVALIDATE"}).catch(()=>{}),(t!=null&&t.hasMore||t!=null&&t.requestAuthRefresh)&&(y=!0)};if(v){y=!0;return}v=n().catch(a=>{console.warn(`[scrollwise] upload failed (${e})`,a)}).finally(()=>{v=null,y&&(y=!1,p("enqueue"))})};chrome.runtime.onInstalled.addListener(()=>{chrome.alarms.create(I,{periodInMinutes:1})});chrome.runtime.onStartup.addListener(async()=>{await T(),(await A()).length&&p("alarm")});chrome.runtime.onMessage.addListener((e,n,a)=>e.type==="TRACKING_EVENT"?(q(e.payload).then(async()=>{p("enqueue"),a({ok:!0})}).catch(t=>a({ok:!1,error:t})),!0):e.type==="AUTH_UPDATE"?(B(e.payload).then(async t=>{await V(),await T(),await F(t),p("enqueue"),a({ok:!0})}).catch(t=>a({ok:!1,error:t})),!0):e.type==="AUTH_LOGOUT"?(Q().then(async()=>{await H(),await T(),await g({type:"AUTH_LOGOUT_BROADCAST"}),await x(),a({ok:!0})}).catch(t=>a({ok:!1,error:t})),!0):e.type==="AUTH_STATE_REQUEST"?(k().then(t=>a({ok:!0,state:t})).catch(t=>a({ok:!1,error:(t==null?void 0:t.message)??"unknown"})),!0):e.type==="TRACKING_TOGGLE"?(T().then(()=>a({ok:!0})),!0):e.type==="TRACKING_STATUS_REQUEST"?(k().then(t=>{const r=!!(t!=null&&t.trackingEnabled&&(t!=null&&t.accessToken));a({enabled:r})}).catch(t=>a({enabled:!1,error:(t==null?void 0:t.message)??"unknown"})),!0):e.type==="FOCUS_START"?(c={isActive:!0,endTime:e.payload.endTime,blocklist:e.payload.blocklist||[]},g({type:"FOCUS_STATE_UPDATE",payload:c}),a({ok:!0}),!0):e.type==="FOCUS_STOP"?(c={isActive:!1,endTime:0,blocklist:[]},g({type:"FOCUS_STATE_UPDATE",payload:c}),a({ok:!0}),!0):!1);let c={isActive:!1,endTime:0,blocklist:[],dailyLimitMinutes:30,usageMinutes:0};const P=e=>{try{const n=new URL(e).hostname;return c.blocklist.some(t=>n.includes(t))?!!(c.isActive||c.usageMinutes>=c.dailyLimitMinutes):!1}catch{return!1}},C=async()=>{var n,a;const e=await k();if(e!=null&&e.accessToken)try{const t=await fetch("https://scroll-tracker.onrender.com/api/analytics/focus",{headers:{Authorization:`Bearer ${e.accessToken}`}});if(t.ok){const r=await t.json();c.dailyLimitMinutes=((n=r.settings)==null?void 0:n.dailyLimitMinutes)||30,c.usageMinutes=r.usageMinutes||0,c.blocklist=((a=r.settings)==null?void 0:a.blocklist)||[];const w=await chrome.tabs.query({});for(const o of w)o.id&&o.url&&P(o.url)&&chrome.tabs.sendMessage(o.id,{type:"SHOW_BLOCK_OVERLAY"}).catch(()=>{})}}catch(t){console.error("Failed to update focus stats",t)}};chrome.alarms.create("focus-stats-poll",{periodInMinutes:1});chrome.alarms.onAlarm.addListener(e=>{e.name==="focus-stats-poll"&&C()});C();chrome.tabs.onUpdated.addListener((e,n,a)=>{(n.status==="loading"||n.status==="complete")&&a.url&&P(a.url)&&chrome.tabs.sendMessage(e,{type:"SHOW_BLOCK_OVERLAY"}).catch(()=>{})});chrome.alarms.onAlarm.addListener(async e=>{e.name!==I||!(await A()).length||p("alarm")});
//# sourceMappingURL=index.ts2.js.map
