import{s as u,a as T,c as k,g as y}from"./auth.js";const s="scrollwise-event-queue",p=t=>({id:typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`${Date.now()}-${Math.random()}`,event:t}),m=t=>Array.isArray(t)?t.map(a=>{if(a&&typeof a=="object"&&"id"in a&&"event"in a){const e=a;if(typeof e.id=="string"&&e.event)return e}return p(a)}):[],h=async t=>{t.length?await chrome.storage.local.set({[s]:t}):await chrome.storage.local.remove(s)},f=async()=>{const a=(await chrome.storage.local.get(s))[s],e=m(a);return Array.isArray(a)&&a.some(r=>!(r&&typeof r=="object"&&"id"in r&&"event"in r))&&e.length&&await h(e),e},A=async t=>{if(!t.length)return[];const a=await f(),e=t.map(p);return await h([...a,...e]),e.map(n=>n.id)},l=async()=>f(),v=async t=>{if(!t.length)return;const e=(await f()).filter(n=>!t.includes(n.id));await h(e)},E=async()=>{await chrome.storage.local.remove(s)},w="http://localhost:3000/api",U=80,I=async t=>{const a=await l();if(!a.length||!t.accessToken)return;const e=a.slice(0,U),n=await fetch(`${w}/tracking/events`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.accessToken}`},body:JSON.stringify({events:e.map(o=>o.event)})});if(n.status===401&&t.refreshToken){const o=await S(t);return{sentIds:[],hasMore:!0,requestAuthRefresh:o}}if(!n.ok)throw new Error(`Failed to upload events: ${n.status}`);await v(e.map(o=>o.id));const r=await l();return{sentIds:e.map(o=>o.id),hasMore:r.length>0}},S=async t=>{const a=await fetch(`${w}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:t.refreshToken})});if(!a.ok)return await chrome.storage.local.set({"scrollwise-auth":{trackingEnabled:!1}}),!1;const e=await a.json();return await chrome.storage.local.set({"scrollwise-auth":{...t,accessToken:e.tokens.accessToken,refreshToken:e.tokens.refreshToken,trackingEnabled:!0}}),!0},g="scrollwise-upload";let d=null,i=!1;const c=t=>{const a=async()=>{var r;const e=await y();if(!(e!=null&&e.accessToken))return;const n=await I(e);(r=n==null?void 0:n.sentIds)!=null&&r.length&&chrome.runtime.sendMessage({type:"SUMMARY_INVALIDATE"}).catch(()=>{}),(n!=null&&n.hasMore||n!=null&&n.requestAuthRefresh)&&(i=!0)};if(d){i=!0;return}d=a().catch(e=>{console.warn(`[scrollwise] upload failed (${t})`,e)}).finally(()=>{d=null,i&&(i=!1,c("enqueue"))})};chrome.runtime.onInstalled.addListener(()=>{chrome.alarms.create(g,{periodInMinutes:1})});chrome.runtime.onStartup.addListener(async()=>{await u(),(await l()).length&&c("alarm")});chrome.runtime.onMessage.addListener((t,a,e)=>t.type==="TRACKING_EVENT"?(A(t.payload).then(async()=>{c("enqueue"),e({ok:!0})}).catch(n=>e({ok:!1,error:n})),!0):t.type==="AUTH_UPDATE"?(T(t.payload).then(async()=>{await u(),c("enqueue"),e({ok:!0})}).catch(n=>e({ok:!1,error:n})),!0):t.type==="AUTH_LOGOUT"?(k().then(async()=>{await E(),await u(),e({ok:!0})}).catch(n=>e({ok:!1,error:n})),!0):t.type==="TRACKING_TOGGLE"?(u().then(()=>e({ok:!0})),!0):t.type==="TRACKING_STATUS_REQUEST"?(y().then(n=>{const r=!!(n!=null&&n.trackingEnabled&&(n!=null&&n.accessToken));e({enabled:r})}).catch(n=>e({enabled:!1,error:(n==null?void 0:n.message)??"unknown"})),!0):!1);chrome.alarms.onAlarm.addListener(async t=>{t.name!==g||!(await l()).length||c("alarm")});
//# sourceMappingURL=index.ts2.js.map
