import{s as w,a as _,c as L,g as I}from"./auth.js";const h="scrollwise-event-queue",U=e=>({id:typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`${Date.now()}-${Math.random()}`,event:e}),M=e=>Array.isArray(e)?e.map(a=>{if(a&&typeof a=="object"&&"id"in a&&"event"in a){const n=a;if(typeof n.id=="string"&&n.event)return n}return U(a)}):[],k=async e=>{e.length?await chrome.storage.local.set({[h]:e}):await chrome.storage.local.remove(h)},A=async()=>{const a=(await chrome.storage.local.get(h))[h],n=M(a);return Array.isArray(a)&&a.some(r=>!(r&&typeof r=="object"&&"id"in r&&"event"in r))&&n.length&&await k(n),n},Q=async e=>{if(!e.length)return[];const a=await A(),n=e.map(U);return await k([...a,...n]),n.map(t=>t.id)},m=async()=>A(),$=async e=>{if(!e.length)return;const n=(await A()).filter(t=>!e.includes(t.id));await k(n)},N=async()=>{await chrome.storage.local.remove(h)},u=e=>e.replace(/\/+$/,""),v=e=>/\/api(?:\/|$)/i.test(e),P=e=>{const a=e.trim();if(!a)return;const n=u(a);try{const t=new URL(n),r=u(t.pathname||"");return!r||r===""?(t.pathname="/api",{base:u(t.toString()),appended:!0}):v(r)?(t.pathname=r,{base:u(t.toString()),appended:!1}):(t.pathname=`${r}/api`,{base:u(t.toString()),appended:!0})}catch{return v(n)?{base:n,appended:!1}:{base:`${n}/api`,appended:!0}}},g=P("https://scroll-tracker.onrender.com/api");if(!g)throw new Error("VITE_API_URL is not configured");g.appended&&console.warn("[scrollwise] VITE_API_URL was missing an /api segment; using",g.base);const b=g.base,q=80;let d=null;const E=e=>new Promise(a=>setTimeout(a,e)),C=async e=>d||(d=(async()=>{try{const a=await fetch(`${b}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e.refreshToken})});if(!a.ok)return await chrome.storage.local.set({"scrollwise-auth":{trackingEnabled:!1}}),!1;const n=await a.json(),r=(await chrome.storage.local.get("scrollwise-auth"))["scrollwise-auth"]??{};return await chrome.storage.local.set({"scrollwise-auth":{...r,accessToken:n.tokens.accessToken,refreshToken:n.tokens.refreshToken,trackingEnabled:!0}}),!0}catch(a){return console.warn("[scrollwise] refresh failed",a.message??a),!1}finally{d=null}})(),d),G=async e=>{const a=await m();if(!a.length||!e.accessToken)return;const n=a.slice(0,q),t={events:n.map(o=>({...o.event,idempotencyKey:o.id}))},r=3;let c=0,i=null;for(;c<r;){c+=1;try{const o=await fetch(`${b}/tracking/events`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.accessToken}`},body:JSON.stringify(t)});if(o.status===401&&e.refreshToken){if(!await C(e))return{sentIds:[],hasMore:!0,requestAuthRefresh:!1};const l=(await chrome.storage.local.get("scrollwise-auth"))["scrollwise-auth"];if(l!=null&&l.accessToken){e={...e,accessToken:l.accessToken,refreshToken:l.refreshToken};continue}}if(!o.ok){if(i=new Error(`Failed to upload events: ${o.status}`),o.status>=500){const s=200*Math.pow(2,c-1);await E(s);continue}throw i}await $(n.map(s=>s.id));const y=await m();return{sentIds:n.map(s=>s.id),hasMore:y.length>0}}catch(o){i=o;const y=200*Math.pow(2,c-1);console.warn("[scrollwise] upload attempt failed",c,o.message??o),await E(y);continue}}if(i)throw i},S="scrollwise-upload";let T=null,p=!1;const f=e=>{const a=async()=>{var r;const n=await I();if(!(n!=null&&n.accessToken))return;const t=await G(n);(r=t==null?void 0:t.sentIds)!=null&&r.length&&chrome.runtime.sendMessage({type:"SUMMARY_INVALIDATE"}).catch(()=>{}),(t!=null&&t.hasMore||t!=null&&t.requestAuthRefresh)&&(p=!0)};if(T){p=!0;return}T=a().catch(n=>{console.warn(`[scrollwise] upload failed (${e})`,n)}).finally(()=>{T=null,p&&(p=!1,f("enqueue"))})};chrome.runtime.onInstalled.addListener(()=>{chrome.alarms.create(S,{periodInMinutes:1})});chrome.runtime.onStartup.addListener(async()=>{await w(),(await m()).length&&f("alarm")});chrome.runtime.onMessage.addListener((e,a,n)=>e.type==="TRACKING_EVENT"?(Q(e.payload).then(async()=>{f("enqueue"),n({ok:!0})}).catch(t=>n({ok:!1,error:t})),!0):e.type==="AUTH_UPDATE"?(_(e.payload).then(async()=>{await w(),f("enqueue"),n({ok:!0})}).catch(t=>n({ok:!1,error:t})),!0):e.type==="AUTH_LOGOUT"?(L().then(async()=>{await N(),await w(),n({ok:!0})}).catch(t=>n({ok:!1,error:t})),!0):e.type==="TRACKING_TOGGLE"?(w().then(()=>n({ok:!0})),!0):e.type==="TRACKING_STATUS_REQUEST"?(I().then(t=>{const r=!!(t!=null&&t.trackingEnabled&&(t!=null&&t.accessToken));n({enabled:r})}).catch(t=>n({enabled:!1,error:(t==null?void 0:t.message)??"unknown"})),!0):!1);chrome.alarms.onAlarm.addListener(async e=>{e.name!==S||!(await m()).length||f("alarm")});
//# sourceMappingURL=index.ts2.js.map
