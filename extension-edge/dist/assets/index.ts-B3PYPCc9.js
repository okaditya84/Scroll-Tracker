import{s as y,a as M,c as Q,g as U}from"./auth-C-GAeNNF.js";const h="scrollwise-event-queue",b=e=>({id:typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`${Date.now()}-${Math.random()}`,event:e}),$=e=>Array.isArray(e)?e.map(a=>{if(a&&typeof a=="object"&&"id"in a&&"event"in a){const n=a;if(typeof n.id=="string"&&n.event)return n}return b(a)}):[],A=async e=>{e.length?await chrome.storage.local.set({[h]:e}):await chrome.storage.local.remove(h)},v=async()=>{const a=(await chrome.storage.local.get(h))[h],n=$(a);return Array.isArray(a)&&a.some(r=>!(r&&typeof r=="object"&&"id"in r&&"event"in r))&&n.length&&await A(n),n},K=async e=>{if(!e.length)return[];const a=await v(),n=e.map(b);return await A([...a,...n]),n.map(t=>t.id)},g=async()=>v(),N=async e=>{if(!e.length)return;const n=(await v()).filter(t=>!e.includes(t.id));await A(n)},P=async()=>{await chrome.storage.local.remove(h)},u=e=>e.replace(/\/+$/,""),E=e=>/\/api(?:\/|$)/i.test(e),q=e=>{const a=e.trim();if(!a)return;const n=u(a);try{const t=new URL(n),r=u(t.pathname||"");return!r||r===""?(t.pathname="/api",{base:u(t.toString()),appended:!0}):E(r)?(t.pathname=r,{base:u(t.toString()),appended:!1}):(t.pathname=`${r}/api`,{base:u(t.toString()),appended:!0})}catch{return E(n)?{base:n,appended:!1}:{base:`${n}/api`,appended:!0}}},m=q("https://scroll-tracker.onrender.com/api");if(!m)throw new Error("VITE_API_URL is not configured");m.appended&&console.warn("[scrollwise] VITE_API_URL was missing an /api segment; using",m.base);const S=m.base,C=80;let d=null;const I=e=>new Promise(a=>setTimeout(a,e)),G=async e=>d||(d=(async()=>{try{const a=await fetch(`${S}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e.refreshToken})});if(!a.ok)return await chrome.storage.local.set({"scrollwise-auth":{trackingEnabled:!1}}),!1;const n=await a.json(),r=(await chrome.storage.local.get("scrollwise-auth"))["scrollwise-auth"]??{};return await chrome.storage.local.set({"scrollwise-auth":{...r,accessToken:n.tokens.accessToken,refreshToken:n.tokens.refreshToken,trackingEnabled:!0}}),!0}catch(a){return console.warn("[scrollwise] refresh failed",a.message??a),!1}finally{d=null}})(),d),O=async e=>{const a=await g();if(!a.length||!e.accessToken)return;const n=a.slice(0,C),t={events:n.map(s=>({...s.event,idempotencyKey:s.id}))},r=3;let c=0,i=null;for(;c<r;){c+=1;try{const s=await fetch(`${S}/tracking/events`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.accessToken}`},body:JSON.stringify(t)});if(s.status===401&&e.refreshToken){if(!await G(e))return{sentIds:[],hasMore:!0,requestAuthRefresh:!1};const l=(await chrome.storage.local.get("scrollwise-auth"))["scrollwise-auth"];if(l!=null&&l.accessToken){e={...e,accessToken:l.accessToken,refreshToken:l.refreshToken};continue}}if(!s.ok){if(i=new Error(`Failed to upload events: ${s.status}`),s.status>=500){const p=200*Math.pow(2,c-1);await I(p);continue}throw i}const o=await s.json().catch(()=>({})),T=Array.isArray(o==null?void 0:o.acceptedKeys)?o.acceptedKeys:n.map(p=>p.id);T.length&&await N(T);const L=await g();return{sentIds:T,hasMore:L.length>0}}catch(s){i=s;const o=200*Math.pow(2,c-1);console.warn("[scrollwise] upload attempt failed",c,s.message??s),await I(o);continue}}if(i)throw i},_="scrollwise-upload";let k=null,w=!1;const f=e=>{const a=async()=>{var r;const n=await U();if(!(n!=null&&n.accessToken))return;const t=await O(n);(r=t==null?void 0:t.sentIds)!=null&&r.length&&chrome.runtime.sendMessage({type:"SUMMARY_INVALIDATE"}).catch(()=>{}),(t!=null&&t.hasMore||t!=null&&t.requestAuthRefresh)&&(w=!0)};if(k){w=!0;return}k=a().catch(n=>{console.warn(`[scrollwise] upload failed (${e})`,n)}).finally(()=>{k=null,w&&(w=!1,f("enqueue"))})};chrome.runtime.onInstalled.addListener(()=>{chrome.alarms.create(_,{periodInMinutes:1})});chrome.runtime.onStartup.addListener(async()=>{await y(),(await g()).length&&f("alarm")});chrome.runtime.onMessage.addListener((e,a,n)=>e.type==="TRACKING_EVENT"?(K(e.payload).then(async()=>{f("enqueue"),n({ok:!0})}).catch(t=>n({ok:!1,error:t})),!0):e.type==="AUTH_UPDATE"?(M(e.payload).then(async()=>{await y(),f("enqueue"),n({ok:!0})}).catch(t=>n({ok:!1,error:t})),!0):e.type==="AUTH_LOGOUT"?(Q().then(async()=>{await P(),await y(),n({ok:!0})}).catch(t=>n({ok:!1,error:t})),!0):e.type==="TRACKING_TOGGLE"?(y().then(()=>n({ok:!0})),!0):e.type==="TRACKING_STATUS_REQUEST"?(U().then(t=>{const r=!!(t!=null&&t.trackingEnabled&&(t!=null&&t.accessToken));n({enabled:r})}).catch(t=>n({enabled:!1,error:(t==null?void 0:t.message)??"unknown"})),!0):!1);chrome.alarms.onAlarm.addListener(async e=>{e.name!==_||!(await g()).length||f("alarm")});
