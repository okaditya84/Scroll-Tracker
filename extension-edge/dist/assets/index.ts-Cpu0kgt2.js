import{s as g,a as M,c as P,g as U}from"./auth-C-GAeNNF.js";const h="scrollwise-event-queue",I=e=>({id:typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`${Date.now()}-${Math.random()}`,event:e}),Q=e=>Array.isArray(e)?e.map(n=>{if(n&&typeof n=="object"&&"id"in n&&"event"in n){const t=n;if(typeof t.id=="string"&&t.event)return t}return I(n)}):[],k=async e=>{e.length?await chrome.storage.local.set({[h]:e}):await chrome.storage.local.remove(h)},v=async()=>{const n=(await chrome.storage.local.get(h))[h],t=Q(n);return Array.isArray(n)&&n.some(r=>!(r&&typeof r=="object"&&"id"in r&&"event"in r))&&t.length&&await k(t),t},$=async e=>{if(!e.length)return[];const n=await v(),t=e.map(I);return await k([...n,...t]),t.map(a=>a.id)},m=async()=>v(),O=async e=>{if(!e.length)return;const t=(await v()).filter(a=>!e.includes(a.id));await k(t)},F=async()=>{await chrome.storage.local.remove(h)},u=e=>e.replace(/\/+$/,""),E=e=>/\/api(?:\/|$)/i.test(e),q=e=>{const n=e.trim();if(!n)return;const t=u(n);try{const a=new URL(t),r=u(a.pathname||"");return!r||r===""?(a.pathname="/api",{base:u(a.toString()),appended:!0}):E(r)?(a.pathname=r,{base:u(a.toString()),appended:!1}):(a.pathname=`${r}/api`,{base:u(a.toString()),appended:!0})}catch{return E(t)?{base:t,appended:!1}:{base:`${t}/api`,appended:!0}}},y=q("https://scroll-tracker.onrender.com/api");if(!y)throw new Error("VITE_API_URL is not configured");y.appended&&console.warn("[scrollwise] VITE_API_URL was missing an /api segment; using",y.base);const S=y.base,C=80;let d=null;const b=e=>new Promise(n=>setTimeout(n,e)),G=async e=>d||(d=(async()=>{try{const n=await fetch(`${S}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e.refreshToken})});if(!n.ok)return await chrome.storage.local.set({"scrollwise-auth":{trackingEnabled:!1}}),!1;const t=await n.json(),r=(await chrome.storage.local.get("scrollwise-auth"))["scrollwise-auth"]??{};return await chrome.storage.local.set({"scrollwise-auth":{...r,accessToken:t.tokens.accessToken,refreshToken:t.tokens.refreshToken,trackingEnabled:!0}}),!0}catch(n){return console.warn("[scrollwise] refresh failed",n.message??n),!1}finally{d=null}})(),d),K=async e=>{const n=await m();if(!n.length||!e.accessToken)return;const t=n.slice(0,C),a={events:t.map(o=>({...o.event,idempotencyKey:o.id}))},r=3;let c=0,i=null;for(;c<r;){c+=1;try{const o=await fetch(`${S}/tracking/events`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.accessToken}`},body:JSON.stringify(a)});if(o.status===401&&e.refreshToken){if(!await G(e))return{sentIds:[],hasMore:!0,requestAuthRefresh:!1};const l=(await chrome.storage.local.get("scrollwise-auth"))["scrollwise-auth"];if(l!=null&&l.accessToken){e={...e,accessToken:l.accessToken,refreshToken:l.refreshToken};continue}}if(!o.ok){if(i=new Error(`Failed to upload events: ${o.status}`),o.status>=500){const p=200*Math.pow(2,c-1);await b(p);continue}throw i}const s=await o.json().catch(()=>({})),T=Array.isArray(s==null?void 0:s.acceptedKeys)?s.acceptedKeys:t.map(p=>p.id);T.length&&await O(T);const L=await m();return{sentIds:T,hasMore:L.length>0}}catch(o){i=o;const s=200*Math.pow(2,c-1);console.warn("[scrollwise] upload attempt failed",c,o.message??o),await b(s);continue}}if(i)throw i},_="scrollwise-upload";let A=null,w=!1;const N=async e=>{const n=await chrome.tabs.query({});await Promise.all(n.map(t=>t.id?chrome.tabs.sendMessage(t.id,e).catch(()=>{}):void 0))},D=()=>new Promise(e=>{chrome.storage.local.set({scrollwiseForceLogoutAt:Date.now()},()=>e())}),j=()=>new Promise(e=>{chrome.storage.local.remove("scrollwiseForceLogoutAt",()=>e())}),f=e=>{const n=async()=>{var r;const t=await U();if(!(t!=null&&t.accessToken))return;const a=await K(t);(r=a==null?void 0:a.sentIds)!=null&&r.length&&chrome.runtime.sendMessage({type:"SUMMARY_INVALIDATE"}).catch(()=>{}),(a!=null&&a.hasMore||a!=null&&a.requestAuthRefresh)&&(w=!0)};if(A){w=!0;return}A=n().catch(t=>{console.warn(`[scrollwise] upload failed (${e})`,t)}).finally(()=>{A=null,w&&(w=!1,f("enqueue"))})};chrome.runtime.onInstalled.addListener(()=>{chrome.alarms.create(_,{periodInMinutes:1})});chrome.runtime.onStartup.addListener(async()=>{await g(),(await m()).length&&f("alarm")});chrome.runtime.onMessage.addListener((e,n,t)=>e.type==="TRACKING_EVENT"?($(e.payload).then(async()=>{f("enqueue"),t({ok:!0})}).catch(a=>t({ok:!1,error:a})),!0):e.type==="AUTH_UPDATE"?(M(e.payload).then(async()=>{await j(),await g(),f("enqueue"),t({ok:!0})}).catch(a=>t({ok:!1,error:a})),!0):e.type==="AUTH_LOGOUT"?(P().then(async()=>{await F(),await g(),await N({type:"AUTH_LOGOUT_BROADCAST"}),await D(),t({ok:!0})}).catch(a=>t({ok:!1,error:a})),!0):e.type==="TRACKING_TOGGLE"?(g().then(()=>t({ok:!0})),!0):e.type==="TRACKING_STATUS_REQUEST"?(U().then(a=>{const r=!!(a!=null&&a.trackingEnabled&&(a!=null&&a.accessToken));t({enabled:r})}).catch(a=>t({enabled:!1,error:(a==null?void 0:a.message)??"unknown"})),!0):!1);chrome.alarms.onAlarm.addListener(async e=>{e.name!==_||!(await m()).length||f("alarm")});
