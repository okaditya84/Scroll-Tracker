import{s as T,a as $,c as O,g as A}from"./auth-DPbEB-kx.js";const h="scrollwise-event-queue",_=e=>({id:typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`${Date.now()}-${Math.random()}`,event:e}),F=e=>Array.isArray(e)?e.map(n=>{if(n&&typeof n=="object"&&"id"in n&&"event"in n){const a=n;if(typeof a.id=="string"&&a.event)return a}return _(n)}):[],v=async e=>{e.length?await chrome.storage.local.set({[h]:e}):await chrome.storage.local.remove(h)},U=async()=>{const n=(await chrome.storage.local.get(h))[h],a=F(n);return Array.isArray(n)&&n.some(r=>!(r&&typeof r=="object"&&"id"in r&&"event"in r))&&a.length&&await v(a),a},q=async e=>{if(!e.length)return[];const n=await U(),a=e.map(_);return await v([...n,...a]),a.map(t=>t.id)},g=async()=>U(),C=async e=>{if(!e.length)return;const a=(await U()).filter(t=>!e.includes(t.id));await v(a)},G=async()=>{await chrome.storage.local.remove(h)},u=e=>e.replace(/\/+$/,""),b=e=>/\/api(?:\/|$)/i.test(e),K=e=>{const n=e.trim();if(!n)return;const a=u(n);try{const t=new URL(a),r=u(t.pathname||"");return!r||r===""?(t.pathname="/api",{base:u(t.toString()),appended:!0}):b(r)?(t.pathname=r,{base:u(t.toString()),appended:!1}):(t.pathname=`${r}/api`,{base:u(t.toString()),appended:!0})}catch{return b(a)?{base:a,appended:!1}:{base:`${a}/api`,appended:!0}}},m=K("https://scroll-tracker.onrender.com/api");if(!m)throw new Error("VITE_API_URL is not configured");m.appended&&console.warn("[scrollwise] VITE_API_URL was missing an /api segment; using",m.base);const I=m.base,N=80;let d=null;const S=e=>new Promise(n=>setTimeout(n,e)),D=async(e,n)=>d||(d=(async()=>{var a;try{const t=await fetch(`${I}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e.refreshToken})});if(!t.ok)return await chrome.storage.local.set({"scrollwise-auth":{trackingEnabled:!1}}),null;const r=await t.json(),s={...(await chrome.storage.local.get("scrollwise-auth"))["scrollwise-auth"]??{},accessToken:r.tokens.accessToken,refreshToken:r.tokens.refreshToken,trackingEnabled:!0};return await chrome.storage.local.set({"scrollwise-auth":s}),await((a=n==null?void 0:n.onTokensUpdated)==null?void 0:a.call(n,s)),s}catch(t){return console.warn("[scrollwise] refresh failed",t.message??t),null}finally{d=null}})(),d),H=async(e,n)=>{const a=await g();if(!a.length||!e.accessToken)return;const t=a.slice(0,N),r={events:t.map(o=>({...o.event,idempotencyKey:o.id}))},E=3;let c=0,s=null;for(;c<E;){c+=1;try{const o=await fetch(`${I}/tracking/events`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.accessToken}`},body:JSON.stringify(r)});if(o.status===401&&e.refreshToken){if(!await D(e,n))return{sentIds:[],hasMore:!0,requestAuthRefresh:!1};const l=(await chrome.storage.local.get("scrollwise-auth"))["scrollwise-auth"];if(l!=null&&l.accessToken){e={...e,accessToken:l.accessToken,refreshToken:l.refreshToken??e.refreshToken};continue}}if(!o.ok){if(s=new Error(`Failed to upload events: ${o.status}`),o.status>=500){const p=200*Math.pow(2,c-1);await S(p);continue}throw s}const i=await o.json().catch(()=>({})),y=Array.isArray(i==null?void 0:i.acceptedKeys)?i.acceptedKeys:t.map(p=>p.id);y.length&&await C(y);const Q=await g();return{sentIds:y,hasMore:Q.length>0}}catch(o){s=o;const i=200*Math.pow(2,c-1);console.warn("[scrollwise] upload attempt failed",c,o.message??o),await S(i);continue}}if(s)throw s},L="scrollwise-upload";let k=null,w=!1;const M=async e=>{const n=await chrome.tabs.query({});await Promise.all(n.map(a=>a.id?chrome.tabs.sendMessage(a.id,e).catch(()=>{}):void 0))},P=async e=>{!(e!=null&&e.accessToken)||!(e!=null&&e.refreshToken)||await M({type:"AUTH_STATE_PUSH",payload:{accessToken:e.accessToken,refreshToken:e.refreshToken,user:e.user}})},j=()=>new Promise(e=>{chrome.storage.local.set({scrollwiseForceLogoutAt:Date.now()},()=>e())}),x=()=>new Promise(e=>{chrome.storage.local.remove("scrollwiseForceLogoutAt",()=>e())}),f=e=>{const n=async()=>{var r;const a=await A();if(!(a!=null&&a.accessToken))return;const t=await H(a,{onTokensUpdated:P});(r=t==null?void 0:t.sentIds)!=null&&r.length&&chrome.runtime.sendMessage({type:"SUMMARY_INVALIDATE"}).catch(()=>{}),(t!=null&&t.hasMore||t!=null&&t.requestAuthRefresh)&&(w=!0)};if(k){w=!0;return}k=n().catch(a=>{console.warn(`[scrollwise] upload failed (${e})`,a)}).finally(()=>{k=null,w&&(w=!1,f("enqueue"))})};chrome.runtime.onInstalled.addListener(()=>{chrome.alarms.create(L,{periodInMinutes:1})});chrome.runtime.onStartup.addListener(async()=>{await T(),(await g()).length&&f("alarm")});chrome.runtime.onMessage.addListener((e,n,a)=>e.type==="TRACKING_EVENT"?(q(e.payload).then(async()=>{f("enqueue"),a({ok:!0})}).catch(t=>a({ok:!1,error:t})),!0):e.type==="AUTH_UPDATE"?($(e.payload).then(async t=>{await x(),await T(),await P(t),f("enqueue"),a({ok:!0})}).catch(t=>a({ok:!1,error:t})),!0):e.type==="AUTH_LOGOUT"?(O().then(async()=>{await G(),await T(),await M({type:"AUTH_LOGOUT_BROADCAST"}),await j(),a({ok:!0})}).catch(t=>a({ok:!1,error:t})),!0):e.type==="AUTH_STATE_REQUEST"?(A().then(t=>a({ok:!0,state:t})).catch(t=>a({ok:!1,error:(t==null?void 0:t.message)??"unknown"})),!0):e.type==="TRACKING_TOGGLE"?(T().then(()=>a({ok:!0})),!0):e.type==="TRACKING_STATUS_REQUEST"?(A().then(t=>{const r=!!(t!=null&&t.trackingEnabled&&(t!=null&&t.accessToken));a({enabled:r})}).catch(t=>a({enabled:!1,error:(t==null?void 0:t.message)??"unknown"})),!0):!1);chrome.alarms.onAlarm.addListener(async e=>{e.name!==L||!(await g()).length||f("alarm")});
