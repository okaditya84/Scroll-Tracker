import{s as m,a as $,c as Q,g as k}from"./auth-DPbEB-kx.js";const h="scrollwise-event-queue",M=e=>({id:typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`${Date.now()}-${Math.random()}`,event:e}),B=e=>Array.isArray(e)?e.map(n=>{if(n&&typeof n=="object"&&"id"in n&&"event"in n){const a=n;if(typeof a.id=="string"&&a.event)return a}return M(n)}):[],S=async e=>{e.length?await chrome.storage.local.set({[h]:e}):await chrome.storage.local.remove(h)},E=async()=>{const n=(await chrome.storage.local.get(h))[h],a=B(n);return Array.isArray(n)&&n.some(r=>!(r&&typeof r=="object"&&"id"in r&&"event"in r))&&a.length&&await S(a),a},D=async e=>{if(!e.length)return[];const n=await E(),a=e.map(M);return await S([...n,...a]),a.map(t=>t.id)},g=async()=>E(),K=async e=>{if(!e.length)return;const a=(await E()).filter(t=>!e.includes(t.id));await S(a)},q=async()=>{await chrome.storage.local.remove(h)},d=e=>e.replace(/\/+$/,""),_=e=>/\/api(?:\/|$)/i.test(e),G=e=>{const n=e.trim();if(!n)return;const a=d(n);try{const t=new URL(a),r=d(t.pathname||"");return!r||r===""?(t.pathname="/api",{base:d(t.toString()),appended:!0}):_(r)?(t.pathname=r,{base:d(t.toString()),appended:!1}):(t.pathname=`${r}/api`,{base:d(t.toString()),appended:!0})}catch{return _(a)?{base:a,appended:!1}:{base:`${a}/api`,appended:!0}}},A=G("https://scroll-tracker.onrender.com/api");if(!A)throw new Error("VITE_API_URL is not configured");A.appended&&console.warn("[scrollwise] VITE_API_URL was missing an /api segment; using",A.base);const I=A.base,H=80;let f=null;const L=e=>new Promise(n=>setTimeout(n,e)),N=async(e,n)=>f||(f=(async()=>{var a;try{const t=await fetch(`${I}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e.refreshToken})});if(!t.ok)return await chrome.storage.local.set({"scrollwise-auth":{trackingEnabled:!1}}),null;const r=await t.json(),c={...(await chrome.storage.local.get("scrollwise-auth"))["scrollwise-auth"]??{},accessToken:r.tokens.accessToken,refreshToken:r.tokens.refreshToken,trackingEnabled:!0};return await chrome.storage.local.set({"scrollwise-auth":c}),await((a=n==null?void 0:n.onTokensUpdated)==null?void 0:a.call(n,c)),c}catch(t){return console.warn("[scrollwise] refresh failed",t.message??t),null}finally{f=null}})(),f),j=async(e,n)=>{const a=await g();if(!a.length||!e.accessToken)return;const t=a.slice(0,H),r={events:t.map(o=>({...o.event,idempotencyKey:o.id}))},b=3;let i=0,c=null;for(;i<b;){i+=1;try{const o=await fetch(`${I}/tracking/events`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.accessToken}`},body:JSON.stringify(r)});if(o.status===401&&e.refreshToken){if(!await N(e,n))return{sentIds:[],hasMore:!0,requestAuthRefresh:!1};const u=(await chrome.storage.local.get("scrollwise-auth"))["scrollwise-auth"];if(u!=null&&u.accessToken){e={...e,accessToken:u.accessToken,refreshToken:u.refreshToken??e.refreshToken};continue}}if(!o.ok){if(c=new Error(`Failed to upload events: ${o.status}`),o.status>=500){const w=200*Math.pow(2,i-1);await L(w);continue}throw c}const l=await o.json().catch(()=>({})),U=Array.isArray(l==null?void 0:l.acceptedKeys)?l.acceptedKeys:t.map(w=>w.id);U.length&&await K(U);const C=await g();return{sentIds:U,hasMore:C.length>0}}catch(o){c=o;const l=200*Math.pow(2,i-1);console.warn("[scrollwise] upload attempt failed",i,o.message??o),await L(l);continue}}if(c)throw c},O="scrollwise-upload";let v=null,T=!1;const y=async e=>{const n=await chrome.tabs.query({});await Promise.all(n.map(a=>a.id?chrome.tabs.sendMessage(a.id,e).catch(()=>{}):void 0))},F=async e=>{!(e!=null&&e.accessToken)||!(e!=null&&e.refreshToken)||await y({type:"AUTH_STATE_PUSH",payload:{accessToken:e.accessToken,refreshToken:e.refreshToken,user:e.user}})},x=()=>new Promise(e=>{chrome.storage.local.set({scrollwiseForceLogoutAt:Date.now()},()=>e())}),R=()=>new Promise(e=>{chrome.storage.local.remove("scrollwiseForceLogoutAt",()=>e())}),p=e=>{const n=async()=>{var r;const a=await k();if(!(a!=null&&a.accessToken))return;const t=await j(a,{onTokensUpdated:F});(r=t==null?void 0:t.sentIds)!=null&&r.length&&chrome.runtime.sendMessage({type:"SUMMARY_INVALIDATE"}).catch(()=>{}),(t!=null&&t.hasMore||t!=null&&t.requestAuthRefresh)&&(T=!0)};if(v){T=!0;return}v=n().catch(a=>{console.warn(`[scrollwise] upload failed (${e})`,a)}).finally(()=>{v=null,T&&(T=!1,p("enqueue"))})};chrome.runtime.onInstalled.addListener(()=>{chrome.alarms.create(O,{periodInMinutes:1})});chrome.runtime.onStartup.addListener(async()=>{await m(),(await g()).length&&p("alarm")});chrome.runtime.onMessage.addListener((e,n,a)=>e.type==="TRACKING_EVENT"?(D(e.payload).then(async()=>{p("enqueue"),a({ok:!0})}).catch(t=>a({ok:!1,error:t})),!0):e.type==="AUTH_UPDATE"?($(e.payload).then(async t=>{await R(),await m(),await F(t),p("enqueue"),a({ok:!0})}).catch(t=>a({ok:!1,error:t})),!0):e.type==="AUTH_LOGOUT"?(Q().then(async()=>{await q(),await m(),await y({type:"AUTH_LOGOUT_BROADCAST"}),await x(),a({ok:!0})}).catch(t=>a({ok:!1,error:t})),!0):e.type==="AUTH_STATE_REQUEST"?(k().then(t=>a({ok:!0,state:t})).catch(t=>a({ok:!1,error:(t==null?void 0:t.message)??"unknown"})),!0):e.type==="TRACKING_TOGGLE"?(m().then(()=>a({ok:!0})),!0):e.type==="TRACKING_STATUS_REQUEST"?(k().then(t=>{const r=!!(t!=null&&t.trackingEnabled&&(t!=null&&t.accessToken));a({enabled:r})}).catch(t=>a({enabled:!1,error:(t==null?void 0:t.message)??"unknown"})),!0):e.type==="FOCUS_START"?(s={isActive:!0,endTime:e.payload.endTime,blocklist:e.payload.blocklist||[]},y({type:"FOCUS_STATE_UPDATE",payload:s}),a({ok:!0}),!0):e.type==="FOCUS_STOP"?(s={isActive:!1,endTime:0,blocklist:[]},y({type:"FOCUS_STATE_UPDATE",payload:s}),a({ok:!0}),!0):!1);let s={isActive:!1,endTime:0,blocklist:[],dailyLimitMinutes:30,usageMinutes:0};const V=e=>{try{const n=new URL(e).hostname;return s.blocklist.some(t=>n.includes(t))?!!(s.isActive||s.usageMinutes>=s.dailyLimitMinutes):!1}catch{return!1}},P=async()=>{var n,a;const e=await k();if(e!=null&&e.accessToken)try{const t=await fetch("https://scroll-tracker.onrender.com/api/analytics/focus",{headers:{Authorization:`Bearer ${e.accessToken}`}});if(t.ok){const r=await t.json();s.dailyLimitMinutes=((n=r.settings)==null?void 0:n.dailyLimitMinutes)||30,s.usageMinutes=r.usageMinutes||0,s.blocklist=((a=r.settings)==null?void 0:a.blocklist)||[]}}catch(t){console.error("Failed to update focus stats",t)}};chrome.alarms.create("focus-stats-poll",{periodInMinutes:1});chrome.alarms.onAlarm.addListener(e=>{e.name==="focus-stats-poll"&&P()});P();chrome.tabs.onUpdated.addListener((e,n,a)=>{n.status==="complete"&&a.url&&V(a.url)&&chrome.tabs.sendMessage(e,{type:"SHOW_BLOCK_OVERLAY"}).catch(()=>{})});chrome.alarms.onAlarm.addListener(async e=>{e.name!==O||!(await g()).length||p("alarm")});
