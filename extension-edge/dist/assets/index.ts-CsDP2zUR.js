import{s as y,a as F,c as Q,g as v}from"./auth-DPbEB-kx.js";const f="scrollwise-event-queue",I=e=>({id:typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`${Date.now()}-${Math.random()}`,event:e}),$=e=>Array.isArray(e)?e.map(n=>{if(n&&typeof n=="object"&&"id"in n&&"event"in n){const a=n;if(typeof a.id=="string"&&a.event)return a}return I(n)}):[],S=async e=>{e.length?await chrome.storage.local.set({[f]:e}):await chrome.storage.local.remove(f)},E=async()=>{const n=(await chrome.storage.local.get(f))[f],a=$(n);return Array.isArray(n)&&n.some(r=>!(r&&typeof r=="object"&&"id"in r&&"event"in r))&&a.length&&await S(a),a},D=async e=>{if(!e.length)return[];const n=await E(),a=e.map(I);return await S([...n,...a]),a.map(t=>t.id)},g=async()=>E(),K=async e=>{if(!e.length)return;const a=(await E()).filter(t=>!e.includes(t.id));await S(a)},q=async()=>{await chrome.storage.local.remove(f)},d=e=>e.replace(/\/+$/,""),_=e=>/\/api(?:\/|$)/i.test(e),B=e=>{const n=e.trim();if(!n)return;const a=d(n);try{const t=new URL(a),r=d(t.pathname||"");return!r||r===""?(t.pathname="/api",{base:d(t.toString()),appended:!0}):_(r)?(t.pathname=r,{base:d(t.toString()),appended:!1}):(t.pathname=`${r}/api`,{base:d(t.toString()),appended:!0})}catch{return _(a)?{base:a,appended:!1}:{base:`${a}/api`,appended:!0}}},k=B("https://scroll-tracker.onrender.com/api");if(!k)throw new Error("VITE_API_URL is not configured");k.appended&&console.warn("[scrollwise] VITE_API_URL was missing an /api segment; using",k.base);const O=k.base,G=80;let h=null;const L=e=>new Promise(n=>setTimeout(n,e)),H=async(e,n)=>h||(h=(async()=>{var a;try{const t=await fetch(`${O}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e.refreshToken})});if(!t.ok)return await chrome.storage.local.set({"scrollwise-auth":{trackingEnabled:!1}}),null;const r=await t.json(),s={...(await chrome.storage.local.get("scrollwise-auth"))["scrollwise-auth"]??{},accessToken:r.tokens.accessToken,refreshToken:r.tokens.refreshToken,trackingEnabled:!0};return await chrome.storage.local.set({"scrollwise-auth":s}),await((a=n==null?void 0:n.onTokensUpdated)==null?void 0:a.call(n,s)),s}catch(t){return console.warn("[scrollwise] refresh failed",t.message??t),null}finally{h=null}})(),h),N=async(e,n)=>{const a=await g();if(!a.length||!e.accessToken)return;const t=a.slice(0,G),r={events:t.map(o=>({...o.event,idempotencyKey:o.id}))},b=3;let c=0,s=null;for(;c<b;){c+=1;try{const o=await fetch(`${O}/tracking/events`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.accessToken}`},body:JSON.stringify(r)});if(o.status===401&&e.refreshToken){if(!await H(e,n))return{sentIds:[],hasMore:!0,requestAuthRefresh:!1};const u=(await chrome.storage.local.get("scrollwise-auth"))["scrollwise-auth"];if(u!=null&&u.accessToken){e={...e,accessToken:u.accessToken,refreshToken:u.refreshToken??e.refreshToken};continue}}if(!o.ok){if(s=new Error(`Failed to upload events: ${o.status}`),o.status>=500){const w=200*Math.pow(2,c-1);await L(w);continue}throw s}const i=await o.json().catch(()=>({})),A=Array.isArray(i==null?void 0:i.acceptedKeys)?i.acceptedKeys:t.map(w=>w.id);A.length&&await K(A);const C=await g();return{sentIds:A,hasMore:C.length>0}}catch(o){s=o;const i=200*Math.pow(2,c-1);console.warn("[scrollwise] upload attempt failed",c,o.message??o),await L(i);continue}}if(s)throw s},P="scrollwise-upload";let U=null,T=!1;const m=async e=>{const n=await chrome.tabs.query({});await Promise.all(n.map(a=>a.id?chrome.tabs.sendMessage(a.id,e).catch(()=>{}):void 0))},M=async e=>{!(e!=null&&e.accessToken)||!(e!=null&&e.refreshToken)||await m({type:"AUTH_STATE_PUSH",payload:{accessToken:e.accessToken,refreshToken:e.refreshToken,user:e.user}})},j=()=>new Promise(e=>{chrome.storage.local.set({scrollwiseForceLogoutAt:Date.now()},()=>e())}),x=()=>new Promise(e=>{chrome.storage.local.remove("scrollwiseForceLogoutAt",()=>e())}),p=e=>{const n=async()=>{var r;const a=await v();if(!(a!=null&&a.accessToken))return;const t=await N(a,{onTokensUpdated:M});(r=t==null?void 0:t.sentIds)!=null&&r.length&&chrome.runtime.sendMessage({type:"SUMMARY_INVALIDATE"}).catch(()=>{}),(t!=null&&t.hasMore||t!=null&&t.requestAuthRefresh)&&(T=!0)};if(U){T=!0;return}U=n().catch(a=>{console.warn(`[scrollwise] upload failed (${e})`,a)}).finally(()=>{U=null,T&&(T=!1,p("enqueue"))})};chrome.runtime.onInstalled.addListener(()=>{chrome.alarms.create(P,{periodInMinutes:1})});chrome.runtime.onStartup.addListener(async()=>{await y(),(await g()).length&&p("alarm")});chrome.runtime.onMessage.addListener((e,n,a)=>e.type==="TRACKING_EVENT"?(D(e.payload).then(async()=>{p("enqueue"),a({ok:!0})}).catch(t=>a({ok:!1,error:t})),!0):e.type==="AUTH_UPDATE"?(F(e.payload).then(async t=>{await x(),await y(),await M(t),p("enqueue"),a({ok:!0})}).catch(t=>a({ok:!1,error:t})),!0):e.type==="AUTH_LOGOUT"?(Q().then(async()=>{await q(),await y(),await m({type:"AUTH_LOGOUT_BROADCAST"}),await j(),a({ok:!0})}).catch(t=>a({ok:!1,error:t})),!0):e.type==="AUTH_STATE_REQUEST"?(v().then(t=>a({ok:!0,state:t})).catch(t=>a({ok:!1,error:(t==null?void 0:t.message)??"unknown"})),!0):e.type==="TRACKING_TOGGLE"?(y().then(()=>a({ok:!0})),!0):e.type==="TRACKING_STATUS_REQUEST"?(v().then(t=>{const r=!!(t!=null&&t.trackingEnabled&&(t!=null&&t.accessToken));a({enabled:r})}).catch(t=>a({enabled:!1,error:(t==null?void 0:t.message)??"unknown"})),!0):e.type==="FOCUS_START"?(l={isActive:!0,endTime:e.payload.endTime,blocklist:e.payload.blocklist||[]},m({type:"FOCUS_STATE_UPDATE",payload:l}),a({ok:!0}),!0):e.type==="FOCUS_STOP"?(l={isActive:!1,endTime:0,blocklist:[]},m({type:"FOCUS_STATE_UPDATE",payload:l}),a({ok:!0}),!0):!1);let l={isActive:!1,endTime:0,blocklist:[]};const R=e=>{if(!l.isActive)return!1;try{const n=new URL(e).hostname;return l.blocklist.some(a=>n.includes(a))}catch{return!1}};chrome.tabs.onUpdated.addListener((e,n,a)=>{n.status==="complete"&&a.url&&R(a.url)&&chrome.tabs.sendMessage(e,{type:"SHOW_BLOCK_OVERLAY"}).catch(()=>{})});chrome.alarms.onAlarm.addListener(async e=>{e.name!==P||!(await g()).length||p("alarm")});
