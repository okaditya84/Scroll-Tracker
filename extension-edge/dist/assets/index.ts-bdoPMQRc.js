import{g as ce}from"./settings-Dy3YOXZy.js";const ie="scrollwise-web",B="scrollwise-extension",G=()=>{try{window.localStorage.removeItem("scrollwise-auth")}catch(e){console.warn("scrollwise: unable to clear web auth storage",e)}window.postMessage({source:B,origin:"extension",type:"AUTH_LOGOUT"},"*")},ae=()=>new Promise(e=>{var t,o;if(!((o=(t=chrome==null?void 0:chrome.storage)==null?void 0:t.local)!=null&&o.get)){e(!1);return}try{chrome.storage.local.get("scrollwiseForceLogoutAt",n=>{e(!!(n!=null&&n.scrollwiseForceLogoutAt))})}catch(n){console.warn("scrollwise: unable to read forced logout flag",n),e(!1)}}),le=()=>new Promise(e=>{var t,o;if(!((o=(t=chrome==null?void 0:chrome.storage)==null?void 0:t.local)!=null&&o.remove)){e();return}try{chrome.storage.local.remove("scrollwiseForceLogoutAt",()=>e())}catch(n){console.warn("scrollwise: unable to clear forced logout flag",n),e()}});let l=!1,g,r=Date.now(),p;const a=[];let H=!1;const de=8,I=6e4,w=new WeakMap;w.set(window,window.scrollY);const k={passive:!0,capture:!0},Y={passive:!1,capture:!0},$={capture:!0},S=new Set,ue=e=>{if(e instanceof Error)return e.message??"";if(typeof e=="object"&&e&&"message"in e){const t=e.message;return typeof t=="string"?t:""}return""},K=e=>{const t=ue(e);return/extension context invalidated|receiving end does not exist|no tab with id/i.test(t)};let m,b=!1;const u=()=>{g&&(window.clearTimeout(g),g=void 0)},A=()=>{u(),!(!l||document.visibilityState!=="visible")&&(g=window.setTimeout(()=>{if(g=void 0,!l||document.visibilityState!=="visible")return;const e=Date.now(),t=Math.max(e-r,I);O({type:"idle",url:location.href,domain:y(location.href),durationMs:t,startedAt:new Date(e-t).toISOString(),metadata:{reason:"pointer-idle",thresholdMs:I}}),r=e,A()},I))},V=()=>{m&&(window.clearTimeout(m),m=void 0)},W=()=>{S.forEach(e=>window.cancelAnimationFrame(e)),S.clear()},L=()=>{H||(H=!0,l=!1,a.length=0,u(),V(),W(),p&&(window.clearInterval(p),p=void 0),ge(),console.debug("scrollwise: extension runtime invalidated, suspending messaging"))},h=()=>{var e;if(H||typeof chrome>"u"||!((e=chrome.runtime)!=null&&e.id))return!1;try{typeof chrome.runtime.getURL=="function"&&chrome.runtime.getURL("")}catch(t){return K(t)&&L(),!1}return!0},d=e=>h()?new Promise(t=>{const o=n=>{K(n)&&L(),t({ok:!1,error:n instanceof Error?n:void 0})};try{const n=chrome.runtime.sendMessage(e,s=>{const c=chrome.runtime.lastError;if(c){o(c);return}t({ok:!0,data:s})});typeof n<"u"&&typeof n.then=="function"&&n.then(s=>{t({ok:!0,data:s})}).catch(o)}catch(n){o(n)}}):(L(),Promise.resolve({ok:!1})),j=()=>{if(window.location.protocol==="http:"||window.location.protocol==="https:")try{const e=window.localStorage.getItem("scrollwise-auth");if(!e)return;const t=JSON.parse(e);return t!=null&&t.accessToken?{accessToken:t.accessToken,refreshToken:t.refreshToken,user:t.user}:void 0}catch(e){console.warn("scrollwise: unable to parse local auth",e);return}},C=e=>{var o;if(!e)return null;const t=((o=e.user)==null?void 0:o.id)??"";return`${e.accessToken}:${e.refreshToken??""}:${t}`};let i=null;const fe=e=>{e!=null&&e.accessToken&&window.postMessage({source:B,origin:"extension",type:"AUTH_UPDATE",payload:e},"*")},me=e=>{if(e!=null&&e.accessToken)try{window.localStorage.setItem("scrollwise-auth",JSON.stringify(e))}catch(t){console.warn("scrollwise: unable to persist web auth storage",t)}},z=e=>{if(!e)return;const t=j(),o=e.user?{...(t==null?void 0:t.user)??{},...e.user}:t==null?void 0:t.user,n={accessToken:e.accessToken??(t==null?void 0:t.accessToken)??"",refreshToken:e.refreshToken??(t==null?void 0:t.refreshToken),user:o};!n.accessToken||!n.refreshToken||!n.user||(me(n),fe(n),i=C(n))},P=async(e=!1)=>{const t=j(),o=C(t);if(!h())return;if(await ae()&&t){G(),i=null,await le();return}const c=e||t&&o!==i&&!i;t&&o!==i&&d({type:"AUTH_UPDATE",payload:{accessToken:t.accessToken,refreshToken:t.refreshToken,user:t.user,trackingEnabled:c?!0:void 0}}),!t&&i&&d({type:"AUTH_LOGOUT"}),i=o};P(!0);window.addEventListener("storage",()=>{P()});p=window.setInterval(()=>{P()},2e3);window.addEventListener("message",e=>{if(e.source!==window)return;const t=e.data;if(!(!t||typeof t!="object"||t.source!==ie)&&h()){if(t.type==="AUTH_UPDATE"){const o=t.payload??{};i=C({accessToken:o.accessToken,refreshToken:o.refreshToken,user:o.user})??i,d({type:"AUTH_UPDATE",payload:{accessToken:o.accessToken,refreshToken:o.refreshToken,user:o.user,trackingEnabled:o.trackingEnabled}})}t.type==="AUTH_LOGOUT"&&(d({type:"AUTH_LOGOUT"}),i=null)}});const N=e=>{l=e,e?(r=Date.now(),A()):(a.length=0,u())},v=()=>{if(!a.length)return;if(!h()){M();return}const e=[...a];a.length=0,d({type:"TRACKING_EVENT",payload:e}).then(t=>{t.ok||(a.unshift(...e),M())})},M=()=>{m&&window.clearTimeout(m),m=window.setTimeout(v,1500)},O=async e=>{if(l){try{const t=await ce(),o=e.domain||y(e.url||location.href);if(t.blocklist.includes(o))return}catch{}if(!h()){L();return}a.push(e),a.length>=8?v():M()}},y=e=>{try{return new URL(e).hostname.replace("www.","")}catch{return location.hostname}},R=e=>!e||e===document||e===document.body||e===document.documentElement?window:e instanceof HTMLElement||e instanceof Element?e:window,J=e=>{if(e===window)return window.scrollY;const t=e.scrollTop;return Number.isFinite(t)?t:0},F=e=>{w.has(e)||w.set(e,J(e))},we=e=>{var T,E;if(e===window)return"window";const t=e,o=((T=t.tagName)==null?void 0:T.toLowerCase())??"element",n=t.id?`#${t.id}`:"";let s="";const c=typeof t.className=="string"?t.className:typeof((E=t.className)==null?void 0:E.baseVal)=="string"?t.className.baseVal:"";return c&&(s=c.split(/\s+/).filter(Boolean).slice(0,2).map(D=>`.${D}`).join("")),`${o}${n}${s}`},x=(e,t="scroll")=>{F(e);const o=w.get(e)??0,n=J(e),s=Math.abs(n-o);if(s<de)return;w.set(e,n);const c=Date.now(),T=(c-r)/1e3,E=T>0?Math.round(s/T):0,_=document.body.scrollHeight||document.documentElement.scrollHeight,D=window.scrollY||document.documentElement.scrollTop,se=_>0?Math.round((D+window.innerHeight)/_*100):0;O({type:"scroll",url:location.href,domain:y(location.href),scrollDistance:s,scrollSpeed:E,maxScrollDepth:se,durationMs:c-r,startedAt:new Date(r).toISOString(),metadata:{viewportHeight:window.innerHeight,container:we(e),source:t}}),r=c},U=(e,t,o=!1)=>{if(o){x(e,t);return}const n=window.requestAnimationFrame(()=>{S.delete(n),x(e,t)});S.add(n)},he=new Set(["ArrowDown","ArrowUp","PageDown","PageUp","Home","End","Space"]),Q=e=>{f();const t=R(e.target);U(t,"scroll",!0)},X=e=>{f();const t=R(e.target);w.has(t)||F(t),U(t,"wheel")},q=e=>{f();const t=R(e.target);U(t,"touch")},Z=e=>{if(!he.has(e.key))return;f();const t=document.activeElement,o=t&&t!==document.body?t:window;F(o),U(o,"key")},ee=e=>{var o;const t=Date.now();O({type:"click",url:location.href,domain:y(location.href),durationMs:t-r,startedAt:new Date(r).toISOString(),metadata:{tag:(o=e.target)==null?void 0:o.tagName,x:e.clientX,y:e.clientY}}),r=t,f()},f=()=>{l&&A()},te=()=>{r=Date.now(),f()},oe=()=>{const e=document.visibilityState==="visible",t=Date.now();O({type:e?"focus":"blur",url:location.href,domain:y(location.href),startedAt:new Date(t).toISOString()}),r=t,e?A():(u(),v())},ne=()=>{u(),r=Date.now(),v()},re=()=>{u(),r=Date.now(),v()};function Te(){b||(document.addEventListener("scroll",Q,k),document.addEventListener("wheel",X,Y),document.addEventListener("touchmove",q,k),document.addEventListener("keydown",Z,$),document.addEventListener("click",ee,{passive:!0}),document.addEventListener("mousemove",te,{passive:!0}),document.addEventListener("visibilitychange",oe),window.addEventListener("beforeunload",ne),window.addEventListener("pagehide",re),b=!0)}function ge(){b&&(document.removeEventListener("scroll",Q,k),document.removeEventListener("wheel",X,Y),document.removeEventListener("touchmove",q,k),document.removeEventListener("keydown",Z,$),document.removeEventListener("click",ee),document.removeEventListener("mousemove",te),document.removeEventListener("visibilitychange",oe),window.removeEventListener("beforeunload",ne),window.removeEventListener("pagehide",re),W(),b=!1)}h()&&chrome.runtime.onMessage.addListener((e,t,o)=>{if(e.type==="SYNC_TRACKING"){N(!!e.enabled),o({enabled:l});return}if(e.type==="AUTH_STATE_PUSH"){z(e.payload),o({ok:!0});return}if(e.type==="AUTH_LOGOUT_BROADCAST"){N(!1),a.length=0,u(),V(),G(),i=null,o({ok:!0});return}if(e.type==="SHOW_BLOCK_OVERLAY"){ve(),o({ok:!0});return}});const ve=()=>{if(document.getElementById("scrollwise-block-overlay"))return;const e=document.createElement("div");e.id="scrollwise-block-overlay",e.style.cssText=`
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.95);
    z-index: 2147483647;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    font-family: system-ui, -apple-system, sans-serif;
    text-align: center;
  `;const t=document.createElement("h1");t.textContent="Deep Work Mode Active",t.style.fontSize="3rem",t.style.marginBottom="1rem";const o=document.createElement("p");o.textContent="You've blocked this site to stay focused. Get back to work!",o.style.fontSize="1.5rem",o.style.color="#ccc",e.appendChild(t),e.appendChild(o),document.body.appendChild(e),document.body.style.overflow="hidden"};f();d({type:"TRACKING_STATUS_REQUEST"}).then(e=>{var t;e.ok&&N(!!((t=e.data)!=null&&t.enabled))});d({type:"AUTH_STATE_REQUEST"}).then(e=>{var t;e.ok&&((t=e.data)!=null&&t.state)&&z(e.data.state)});Te();
