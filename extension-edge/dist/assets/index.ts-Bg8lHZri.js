import{s as l,a as k,c as v,g as y}from"./auth-C-GAeNNF.js";const i="scrollwise-event-queue",m=t=>({id:typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`${Date.now()}-${Math.random()}`,event:t}),E=t=>Array.isArray(t)?t.map(a=>{if(a&&typeof a=="object"&&"id"in a&&"event"in a){const n=a;if(typeof n.id=="string"&&n.event)return n}return m(a)}):[],p=async t=>{t.length?await chrome.storage.local.set({[i]:t}):await chrome.storage.local.remove(i)},g=async()=>{const a=(await chrome.storage.local.get(i))[i],n=E(a);return Array.isArray(a)&&a.some(r=>!(r&&typeof r=="object"&&"id"in r&&"event"in r))&&n.length&&await p(n),n},I=async t=>{if(!t.length)return[];const a=await g(),n=t.map(m);return await p([...a,...n]),n.map(e=>e.id)},d=async()=>g(),U=async t=>{if(!t.length)return;const n=(await g()).filter(e=>!t.includes(e.id));await p(n)},S=async()=>{await chrome.storage.local.remove(i)},s=t=>t.replace(/\/+$/,""),w=t=>/\/api(?:\/|$)/i.test(t),b=t=>{const a=t.trim();if(!a)return;const n=s(a);try{const e=new URL(n),r=s(e.pathname||"");return!r||r===""?(e.pathname="/api",{base:s(e.toString()),appended:!0}):w(r)?(e.pathname=r,{base:s(e.toString()),appended:!1}):(e.pathname=`${r}/api`,{base:s(e.toString()),appended:!0})}catch{return w(n)?{base:n,appended:!1}:{base:`${n}/api`,appended:!0}}},h=b("https://scroll-tracker.onrender.com/api");if(!h)throw new Error("VITE_API_URL is not configured");h.appended&&console.warn("[scrollwise] VITE_API_URL was missing an /api segment; using",h.base);const T=h.base,_=80,L=async t=>{const a=await d();if(!a.length||!t.accessToken)return;const n=a.slice(0,_),e=await fetch(`${T}/tracking/events`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.accessToken}`},body:JSON.stringify({events:n.map(o=>o.event)})});if(e.status===401&&t.refreshToken){const o=await Q(t);return{sentIds:[],hasMore:!0,requestAuthRefresh:o}}if(!e.ok)throw new Error(`Failed to upload events: ${e.status}`);await U(n.map(o=>o.id));const r=await d();return{sentIds:n.map(o=>o.id),hasMore:r.length>0}},Q=async t=>{const a=await fetch(`${T}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:t.refreshToken})});if(!a.ok)return await chrome.storage.local.set({"scrollwise-auth":{trackingEnabled:!1}}),!1;const n=await a.json();return await chrome.storage.local.set({"scrollwise-auth":{...t,accessToken:n.tokens.accessToken,refreshToken:n.tokens.refreshToken,trackingEnabled:!0}}),!0},A="scrollwise-upload";let f=null,u=!1;const c=t=>{const a=async()=>{var r;const n=await y();if(!(n!=null&&n.accessToken))return;const e=await L(n);(r=e==null?void 0:e.sentIds)!=null&&r.length&&chrome.runtime.sendMessage({type:"SUMMARY_INVALIDATE"}).catch(()=>{}),(e!=null&&e.hasMore||e!=null&&e.requestAuthRefresh)&&(u=!0)};if(f){u=!0;return}f=a().catch(n=>{console.warn(`[scrollwise] upload failed (${t})`,n)}).finally(()=>{f=null,u&&(u=!1,c("enqueue"))})};chrome.runtime.onInstalled.addListener(()=>{chrome.alarms.create(A,{periodInMinutes:1})});chrome.runtime.onStartup.addListener(async()=>{await l(),(await d()).length&&c("alarm")});chrome.runtime.onMessage.addListener((t,a,n)=>t.type==="TRACKING_EVENT"?(I(t.payload).then(async()=>{c("enqueue"),n({ok:!0})}).catch(e=>n({ok:!1,error:e})),!0):t.type==="AUTH_UPDATE"?(k(t.payload).then(async()=>{await l(),c("enqueue"),n({ok:!0})}).catch(e=>n({ok:!1,error:e})),!0):t.type==="AUTH_LOGOUT"?(v().then(async()=>{await S(),await l(),n({ok:!0})}).catch(e=>n({ok:!1,error:e})),!0):t.type==="TRACKING_TOGGLE"?(l().then(()=>n({ok:!0})),!0):t.type==="TRACKING_STATUS_REQUEST"?(y().then(e=>{const r=!!(e!=null&&e.trackingEnabled&&(e!=null&&e.accessToken));n({enabled:r})}).catch(e=>n({enabled:!1,error:(e==null?void 0:e.message)??"unknown"})),!0):!1);chrome.alarms.onAlarm.addListener(async t=>{t.name!==A||!(await d()).length||c("alarm")});
